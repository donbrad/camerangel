<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="utf-8" />
    <!-- Styles -->
    
    <link href="kendo/styles/kendo.mobile.aLL.min.css" rel="stylesheet" />
    <link href="kendo/styles/kendo.mobile.flat.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="styles/font-awesome.css">
    <link href="styles/main.css" rel="stylesheet" />
 <!-- External scripts -->
    <script src="cordova.js"></script>
    <script src="kendo/js/jquery.min.js"></script>
    <script src="kendo/js/kendo.mobile.min.js"></script>
	<script src="scripts/parse.js"></script>
    <script src="https://cdn.pubnub.com/pubnub-dev.js"></script>
    <script src="scripts/appData.js"></script>
    <script src="scripts/app.js"></script>
    <script src="scripts/guid.js"></script>
    <script src="scripts/uuid.js"></script>
    
<script>

function togglePrivate (e) {
    e.preventDefault();
    var privateMode = !APP.models.home.privateMode;
    APP.models.home.privateMode = privateMode;
    if (privateMode) {
        $('.privateModeButton').text('Private');
        $('.user-content').removeClass('publicMode');
        $('.user-content').addClass('privateMode');

    } else {
        $('.privateModeButton').text('Public');
        $('.user-content').addClass('publicMode');
        $('.user-content').removeClass('privateMode');
    }
}

function beforeShowFilter() {

    if (APP.models.home.privateMode) {
        $('.privateModeButton').text('Private');
        $('.user-content').removeClass('publicMode');
        $('.user-content').addClass('privateMode');

    } else {
        $('.privateModeButton').text('Public');
        $('.user-content').addClass('publicMode');
        $('.user-content').removeClass('privateMode');
    }   

    $(".user-content").kendoTouch({
        touchstart: function(e) {
            e.preventDefault();
            if (!APP.models.home.privateMode)
                return;
             $('.user-content').addClass('publicMode');
             $('.user-content').removeClass('privateMode');
        },
        dragend: function(e) {
            e.preventDefault();
             if (!APP.models.home.privateMode)
                return;
             $('.user-content').removeClass('publicMode');
             $('.user-content').addClass('privateMode');
        },
    }); 
}

function homeBeforeShow () {

    if (APP.models.profile.currentUser) {
        // Have current user - redirect to user view

        APP.models.profile.username =  APP.models.profile.currentUser.username;
        APP.models.profile.email =  APP.models.profile.currentUser.email;
        APP.models.profile.phone =  APP.models.profile.currentUser.phone;
        APP.models.profile.alias =  APP.models.profile.currentUser.alias;
        APP.models.profile.udid =  APP.models.profile.currentUser.udid;
        APP.models.profile.userUUID = APP.models.profile.currentUser.UUID;
        APP.kendo.navigate('#home');

    } else {
        // No current user -redirect to no user view
       APP.kendo.navigate('#nouser');
    }
} 

function homeSignout (e) {

    e.preventDefault();
    Parse.User.logOut();
    APP.models.profile.parseUser = null;
    APP.models.profile.currentUser.unbind('change', syncProfile);
    APP.models.profile.currentUser.set('username', null);
    APP.models.profile.currentUser.set('email', null);
    APP.models.profile.currentUser.set('phone',null);
    APP.models.profile.currentUser.set('alias', null);
    APP.models.profile.currentUser.set('userUUID', null);
    APP.models.profile.currentUser.set('phoneVerified', null);
    APP.models.profile.currentUser.set('emailVerified', null);
    APP.models.profile.parseACL = '';
    APP.kendo.navigate('#newuserhome');
}

function homeSignin (e) {
    e.preventDefault();
    
   Parse.User.logIn($('#home-signin-username').val(), $('#home-signin-password').val(), {
        success: function(user) {
        // Do stuff after successful login.
            closeModalViewLogin();
            APP.models.profile.parseUser = user;
            APP.models.profile.currentUser.set('username', APP.models.profile.parseUser.get('username'));
            APP.models.profile.currentUser.set('email', APP.models.profile.parseUser.get('email'));
            APP.models.profile.currentUser.set('phone', APP.models.profile.parseUser.get('phone'));
            APP.models.profile.currentUser.set('alias', APP.models.profile.parseUser.get('alias'));
            APP.models.profile.currentUser.set('userUUID', APP.models.profile.parseUser.get('userUUID'));
            APP.models.profile.currentUser.set('phoneVerified', APP.models.profile.parseUser.get('phoneVerified'));
            APP.models.profile.currentUser.set('emailVerified', APP.models.profile.parseUser.get('emailVerified'));
            APP.models.profile.parseACL = new Parse.ACL(APP.models.profile.parseUser);
            APP.models.profile.currentUser.bind('change', syncProfile);
            window.onUserSignIn();
            
            if (!APP.models.profile.currentUser.get('phoneVerified')) {
                var phone = APP.models.profile.currentUser.get('phone');
               Parse.Cloud.run('sendPhoneVerificationCode', { phoneNumber:  phone}, {
                              success: function(result) {
                                  mobileNotify('Please verify your phone');
                                  $("#modalview-verifyPhone").data("kendoMobileModalView").open();
                              },
                             error: function (result,error){
                                 mobileNotify("Error sending phone verification " + error);
                             }
                         });
            }
            APP.kendo.navigate('#home');
        },
        error: function(user, error) {
        // The login failed. Check error to see why.
             alert("Error: " + error.code + " " + error.message);
        }
    });
}

function closeModalViewSupport() {
     $('#modalview-support').kendoMobileModalView("close");
}
function closeModalViewLogin() {
    $("#modalview-login").kendoMobileModalView("close");
}

function closeModalViewSignup() {
    $("#modalview-signup").kendoMobileModalView("close");
}

function closeModalViewRecoverPassword() {
    $("#modalview-recoverPassword").kendoMobileModalView("close");
}

function closeModalViewAddChannel() {
    $("#modalview-channels-addChannel").kendoMobileModalView("close");
}

function closeModalViewAddPhoto() {
    $("#modalview-gallery-addPhoto").kendoMobileModalView("close");
}
    
function closeModalViewAddPlace() {
    $("#modalview-places-addPlace").kendoMobileModalView("close");
}


function closeModalViewEditChannel() {
    $("#modalview-channels-editChannel").kendoMobileModalView("close");
}
    
function closeModalViewVerifyPhone() {
    $("#modalview-channels-verifyPhone").kendoMobileModalView("close");
}
    
function syncCurrentContact(e) {
    updateParseObject('contacts','uuid', APP.models.contacts.currentContact.uuid, e.field, this[e.field]);  
    APP.models.contacts.currentModel.set(e.field, this[e.field]);
}
    
function syncProfile (e) {
    APP.models.profile.parseUser.set(e.field, APP.models.profile.currentUser.get(e.field));
    APP.models.profile.parseUser.save(null, {
        success : function (user){
            mobileNotify("Updated your " + e.field);
        },
        error: function (user, error){
            mobileNotify("Profile save error: " + error);
        }
    });
}

function personalMessage() {
    
}
    
function editContact() {
    APP.kendo.navigate("#editContact");  
}

function updateParseObject(objectName, idField, idFieldValue, newField, newFieldValue) {
    var object = Parse.Object.extend(objectName);
    var query = new Parse.Query(object);
    query.equalTo(idField, idFieldValue);
    query.find({
      success: function(results) {
        results[0].set(newField, newFieldValue);
        results[0].save({
          success: function(myObject) {
            // The object was deleted from the Parse Cloud.
          },
          error: function(myObject, error) {
             mobileNotify("Error: " + error.code + " " + error.message);
          }
        });
        
      },
      error: function(error) {
        mobileNotify("Error: " + error.code + " " + error.message);
      }
    });
}
    
function deleteParseObject(objectName, field, fieldValue) {
    var object = Parse.Object.extend(objectName);
    var query = new Parse.Query(object);
    query.equalTo(field, fieldValue);
    query.find({
      success: function(results) {
        results[0].destroy({
          success: function(myObject) {
            // The object was deleted from the Parse Cloud.
          },
          error: function(myObject, error) {
            // The delete failed.
            // error is a Parse.Error with an error code and message.
              mobileNotify("Error: " + error.code + " " + error.message);
          }
        });
        
      },
      error: function(error) {
        mobileNotify("Error: " + error.code + " " + error.message);
      }
    });
}
    
function getBase64FromImageUrl(URL, callback) {
    var img = new Image();
    img.src = URL;
    img.onload = function () {


    var canvas = document.createElement("canvas");
    canvas.width =this.width;
    canvas.height =this.height;

    var ctx = canvas.getContext("2d");
    ctx.drawImage(this, 0, 0);


    var dataURL = canvas.toDataURL("image/png");

    callback(dataURL.replace(/^data:image\/(png|jpg);base64,/, ""));

    }
}
    
function deleteContact() {
    var dataSource = APP.models.contacts.contactsDS;
    dataSource.filter( { field: "uuid", operator: "eq", value: APP.models.contacts.currentContact.uuid });
    var view = dataSource.view();
    var contact = view[0];
    dataSource.remove(contact); 
    deleteParseObject("contacts", 'uuid', APP.models.contacts.currentContact.uuid);
    
}

function contactSendSMS() {

    var number = APP.models.contacts.currentContact.phone;
    var message = "ghostgrams";


    //CONFIGURATION
    var options = {
        android: {
            intent: 'INTENT'  // send SMS with the native android SMS messaging
            //intent: '' // send SMS without openning any other app
        }
    };

    var success = function () { mobileNotify('Message sent successfully'); };
    var error = function (e) { mobileNotify('Message Failed:' + e); };
    
    if (window.navigator.simulator === true){
   //running in the simulator
        alert('Simulating SMS to ' + number + ' message: ' + message);
    } else {
       sms.send(number, message, options, success, error);
    }

}
    
function updateCurrentContact (contact) {
   
    // Wish observables set took an object -- need to set fields individually
     APP.models.contacts.currentModel = contact;
    APP.models.contacts.currentContact.unbind('change' , syncCurrentContact);
    APP.models.contacts.currentContact.set('name', contact.name);
    APP.models.contacts.currentContact.set('alias', contact.alias);
    APP.models.contacts.currentContact.set('phone', contact.phone);
    APP.models.contacts.currentContact.set('email', contact.email);
    APP.models.contacts.currentContact.set('address', contact.address);
    APP.models.contacts.currentContact.set('uuid', contact.uuid);
    APP.models.contacts.currentContact.set('privateChannel', contact.privateChannel === 'true');
    APP.models.contacts.currentContact.bind('change' , syncCurrentContact);
   
   
}

function onCommandActionSheet(e) {
    var currentTarget = e.currentTarget,
        parentElement = currentTarget.parent();

    setTimeout(function() {
        currentTarget.remove().appendTo(parentElement);
    }, 100);
}
    
function onInitContacts(e) {
   e.preventDefault();
    
    function swipe(e) {
        var button = kendo.fx($(e.touch.currentTarget).find("[data-role=button]"));
        button.expand().duration(200).play();        
    }
    
    function tap(e) {
        var contact = APP.models.contacts.contactsDS.getByUid($(e.touch.target).attr("data-uid"));
        updateCurrentContact(contact);
        APP.kendo.navigate("#editContact");
    }
     function touchstart(e) {
        var target = $(e.touch.initialTouch),
            listview = $("#contacts-listview").data("kendoMobileListView"),
            contact,
            dataSource = APP.models.contacts.contactsDS,
            button = $(e.touch.target).find("[data-role=button]:visible");
            
        if (target.closest("[data-role=button]")[0]) {
            contact = dataSource.getByUid($(e.touch.target).attr("data-uid"));
            this.events.cancel();
            e.event.stopPropagation();
            updateCurrentContact(contact);
             $("#contactActions").data("kendoMobileActionSheet").open();
            
        	
       } else if (button[0]) {
            button.hide();
            //prevent `swipe`
            this.events.cancel();
        } else {
            listview.items().find("[data-role=button]:visible").hide();
        }
    }
     $("#contacts-listview").kendoMobileListView({
        dataSource: APP.models.contacts.contactsDS,
        template: $("#contactsTemplate").html(),
        filterable: {
            field: "name",
            operator: "startswith"
        }
     }).kendoTouch({
            filter: ">li",
            enableSwipe: true,
            tap: tap,
            touchstart: touchstart,
            swipe: swipe
       });
}
    
    
function onInitContactImport (e) {
    e.preventDefault();
    $("#contactimport-listview").kendoMobileListView({
            dataSource: APP.models.contacts.deviceContactsDS,
            template: $("#deviceContactsTemplate").text(),
            click: function(e) {
               APP.models.contacts.currentDeviceContact = e.dataItem;
               APP.models.contacts.emailArray = new Array();
                
               for (var i = 0; i<APP.models.contacts.currentDeviceContact.emails.length; i++) {
                    var email = new Object();
                    email.name = APP.models.contacts.currentDeviceContact.emails[i].name;
                    email.address =  APP.models.contacts.currentDeviceContact.emails[i].address;

                   APP.models.contacts.emailArray.push(email);

               }

               APP.models.contacts.phoneArray = new Array();
                 for (var j = 0; j<APP.models.contacts.currentDeviceContact.phoneNumbers.length; j++) {
                    var phone = new Object();
                    phone.name = APP.models.contacts.currentDeviceContact.phoneNumbers[j].name;
                    phone.number =  APP.models.contacts.currentDeviceContact.phoneNumbers[j].number;

                   APP.models.contacts.phoneArray.push(phone);

               }
                
                APP.models.contacts.addressArray = new Array();
                    for (var a = 0; a<APP.models.contacts.currentDeviceContact.addresses.length; a++) {
                    var address = new Object();
                    address.name = APP.models.contacts.currentDeviceContact.addresses[a].name;
                    address.address =  APP.models.contacts.currentDeviceContact.addresses[a].fullAddress;

                    APP.models.contacts.addressArray.push(address);
               }
               
               APP.models.contacts.phoneDS.data( APP.models.contacts.phoneArray);
               APP.models.contacts.emailDS.data( APP.models.contacts.emailArray);
               APP.models.contacts.addressDS.data( APP.models.contacts.addressArray);
               APP.kendo.navigate('#addContact');
             
            }
    });
}
    
function handleParseError(err) {
  switch (err.code) {
    case Parse.Error.INVALID_SESSION_TOKEN:
      Parse.User.logOut();
        APP.models.profile.currentUser = '';
        APP.models.profile.username =  '';
        APP.models.profile.email =  '';
        APP.models.profile.phone =  '';
        APP.models.profile.alias =  '';
        APP.models.profile.userUUID = '';
        APP.kendo.navigate('#newuserhome');
      break;
  }
}
    
function contactsFindContacts(e) {
    e.preventDefault(e);   
    var query = $('#contactSearchQuery').val();
   
    var options      = new ContactFindOptions();
    options.filter   = query
    options.multiple = true;
    var fields       = ["name", "phoneNumbers", "emails", "addresses"];
     
    navigator.contacts.find(fields, function(contacts){
        
        APP.models.contacts.deviceContactsDS.data([]);
        var contactsCount = contacts.length;
        
        for (var i=0;  i<contactsCount; i++){
            var contactItem = new Object();
            contactItem.type = "device";
            contactItem.name = contacts[i].name.formatted;
            contactItem.phoneNumbers = new Array();
            if (contacts[i].phoneNumbers !== null) {
                for (var j=0; j<contacts[i].phoneNumbers.length; j++){
                    var phone = new Object();
                    phone.name = contacts[i].phoneNumbers[j].type + " : " + contacts[i].phoneNumbers[j].value ;
                    phone.number = contacts[i].phoneNumbers[j].value;
                    contactItem.phoneNumbers.push(phone);
                }
            }
            
            contactItem.emails = new Array();
            if (contacts[i].emails !== null) {
                 for (var k=0; k<contacts[i].emails.length; k++){
                    var email = new Object();
                    email.name = contacts[i].emails[k].type + " : " + contacts[i].emails[k].value;
                    email.address = contacts[i].emails[k].value;
                    contactItem.emails.push(email);
                }
            }
            
            contactItem.addresses = new Array();
              if (contacts[i].addresses !== null) {
                 for (var a=0; a<contacts[i].addresses.length; a++){
                    var address = new Object();
                    if (contacts[i].addresses[a].type === null) {
                         address.type = 'Home';
                    } else {
                        address.type = contacts[i].addresses[a].type;
                    }
                    address.name = address.type + " : " + contacts[i].addresses[a].streetAddress + ', ' +
                        contacts[i].addresses[a].locality;
                    address.address = contacts[i].addresses[a].streetAddress;
                    address.city = contacts[i].addresses[a].locality;
                    address.state = contacts[i].addresses[a].region;
                    address.zipcode = contacts[i].addresses[a].postalcode;
                    address.fullAddress = address.address + " ," + address.city + ' , ' + address.state;
                    contactItem.addresses.push(address);
                }
            } 
            contactItem.photo = 'images/missing_profile_photo.jpg';
            if (contacts[i].photos !== null) {
                contactItem.photo = contacts[i].photos[0].value;
            } 
            APP.models.contacts.deviceContactsDS.add(contactItem);
        }
         
    },function(error){alert(error);}, options);
 }
    
function doShowAddContacts() {
    var data = APP.models.contacts.currentDeviceContact;
    
    $("#addContactName").val(data.name);
    
    if (data.photo === null) {
        $("#addContactPhoto").attr("src",'images/missing_profile_photo.jpg');
    } else {
         $("#addContactPhoto").attr("src",data.photo);
    }
   
    
    
   
}

function contactsAddContact(e){
    e.preventDefault(e);
     var Contacts = Parse.Object.extend("contacts");
    var contact = new Contacts();
    
    var name = $('#addContactName').val(),
        alias = $('#addContactAlias').val(),
        phone = $('#addContactPhone').val(),
        email = $('#addContactEmail').val(), 
        private = $('#addContactPrivate').val(),
        photo = $('#addContactPhoto').prop('src'),
        address = $('#addContactAddress').val();
        guid = uuid.v4();
 
    //phone = phone.replace(/\+[0-9]{1-2}/,'');
    phone = phone.replace(/\D+/g, "");
    mobileNotify("Saving new contact...");
    contact.setACL(APP.models.profile.parseACL);
    contact.set("name", name );
    contact.set("alias", alias);
    contact.set("phone", phone);
    contact.set("email", email);
    contact.set("address", address);
    contact.set("photo", photo);
    contact.set("privateChannel", private === 'yes' ? true : false);
    contact.set("uuid", guid);
    
    getBase64FromImageUrl(photo, function (fileData) {
        var parseFile = new Parse.File(guid+".png", {base64 : fileData}, "image/png");
        parseFile.save().then(function() {
            contact.set("parsePhoto", parseFile);
             contact.save(null, {
                  success: function(contact) {
                    // Execute any logic that should take place after the object is saved.
                    mobileNotify('Added contact : ' + contact.get('name'));
                    APP.models.contacts.contactsDS.add(contact.attributes);
                    APP.kendo.navigate('#contactImport');
                  },
                  error: function(contact, error) {
                    // Execute any logic that should take place if the save fails.
                    // error is a Parse.Error with an error code and message.
                      handleParseError(error);
                  }
                });
            }, function(error) {
              // The file either could not be read, or could not be saved to Parse.
                     handleParseError(error);
            }); 
        });    
}
    
function contactsPickContact(e) {
   // e.preventDefault(e);
    navigator.contacts.pickContact(function(contact){
       alert(JSON.stringify(contact));
    },function(err){
        alert('Error: ' + err);
    });
}
    
function verifyPhone(e){
    e.preventDefault();
    var code = $('#verifyPhone-code').val();
    // all verification codes are 5 or 6 numbers
    if (code.length < 5) {
       mobileNotify("Invalid verification code, please try again");
        return;
    }
    
    Parse.Cloud.run('verifyPhoneNumber', { code: code }, 
    {
        success: function(result) {
          if (result.verified) {
               mobileNotify("Your phone number is verified.  Thank You!");
               $("#modalview-verifyPhone").data("kendoMobileModalView").close();
          } else {
               mobileNotify("Sorry, your verification number: ' + result.recieved + ' didn't match. ");
          }
         
        },
        error: function (result,error){
            mobileNotify('Error verifying phone ' + error);
        }
    });
    
}
function homeCreateAccount(e) {
    e.preventDefault();

    var user = new Parse.User();
    var username = $('#home-signup-username').val();
    var password = $('#home-signup-password').val();
    var phone = $('#home-signup-phone').val();
    var alias = $('#home-signup-alias').val();

    var userUUID = uuid.v4();
    
    // clean up the phone number
   // phone = phone.replace(/\+[0-9]{1-2}/,'');
    phone = phone.replace(/\D+/g, "");
    
    Parse.Cloud.run('preflightPhone', { phone: phone }, {
      success: function(result) {
           if (result.status !== 'ok' || result.count !== 0) {
               mobileNotify("Phone number matches existing user");
               return;
           } else {
               
                 //Phone number isn't a duplicate -- create user
                user.set("username", username);
                user.set("password", password);
                user.set("email", username);
                user.set("phone", phone);
                user.set("alias", alias);
                user.set("aliasPublic", "ghostgram user");
                user.set("profilePhoto", null)
                user.set("phoneVerified", false);
                user.set("userUUID", userUUID);

                user.signUp(null, {
                    success: function(user) {
                        // Hooray! Let them use the app now.
                       closeModalViewSignup();
                        APP.models.profile.currentUser.set('username', user.get('username'));
                        APP.models.profile.currentUser.set('email', user.get('email'));
                        APP.models.profile.currentUser.set('phone', user.get('phone'));
                        APP.models.profile.currentUser.set('alias', user.get('alias'));
                        APP.models.profile.currentUser.set('userUUID', user.get('userUUID'));
                        APP.models.profile.currentUser.set('phoneVerified', false);
                        APP.models.profile.currentUser.set('emailVerified',user.get('emailVerified'));
                        APP.models.profile.currentUser.bind('change', syncProfile);
                        APP.models.profile.parseACL = new Parse.ACL(Parse.User.current());
                       mobileNotify('Welcome to ghostgrams!');
                         Parse.Cloud.run('sendPhoneVerificationCode', { phoneNumber: phone }, {
                              success: function (result) {
                                  modileNotify('Please verify your phone');
                                  $("#modalview-verifyPhone").data("kendoMobileModalView").open();
                              },
                             error: function (result, error){
                                 mobileNotify('Error sending verification code ' + error);
                             }
                         });
                       
                        
            
                       ///APP.kendo.navigate('#home');
                    },

                    error: function(user, error) {
                    // Show the error message somewhere and let the user try again.
                    mobileNotify("Error: " + error.code + " " + error.message);
                    }
                });
            
           }
      },
      error: function(error) {
          mobileNotify("Error checking phone number" + error);
      }
    });
  }

function onInitGallery(e){
    e.preventDefault();
    // ToDo: Initialize list view
    
     $("#gallery-listview").kendoMobileListView({
        dataSource: APP.models.gallery.galleryDS,
        template: $("#gallery-listview-template").text(),
        filterable: {
            field: "name",
            operator: "startswith"
        },
        endlessScroll: true
    }); 
}

function mobileNotify(message) {
    if (window.navigator.simulator === true){
    //running in the simulator
        alert(message);
    }
    else{
    //running on a device
        window.plugins.toast.showShortTop(message);
    }
 
}
function addChannel(e) {
    e.preventDefault();

    var Channels = Parse.Object.extend("channels");
    var channel = new Channels();
    
    var name = $('#channels-addChannel-name').val(),
        media = $('#channels-addChannel-media').val(),
        archive = $('#channels-addChannel-archive').val(),
        expirationDate = $('#channels-addChannel-expirationDate').val(),
        description = $('#channels-addChannel-description').val(), 
        guid = uuid.v4()
        
    channel.set("name", name );
    channel.set("isOwner", true);
    channel.set("media",  media === "true" ? true : false);
    channel.set("archive",  archive === "true" ? true : false);
    channel.set("expirationDate", expirationDate);
    channel.set("description", description);
    channel.set("channelId", guid);
    
    channel.setACL(APP.models.profile.parseACL);
    channel.save(null, {
      success: function(channel) {
        // Execute any logic that should take place after the object is saved.
         
          APP.models.channels.channelsDS.add(channel.attributes);
          closeModalViewAddChannel();
          
          mobileNotify('Added channel : ' + channel.get('name'));
      },
      error: function(channel, error) {
        // Execute any logic that should take place if the save fails.
        // error is a Parse.Error with an error code and message.
        mobileNotify('Error creating channel: ' + error.message);
        handleParseError(error);
      }
    });
 
}
    
function syncCurrentChannel(e)
{
   updateParseObject('channels','channelId', APP.models.channels.currentChannel.channelId, e.field, this[e.field]); 
   APP.models.channels.currentModel.set(e.field, this[e.field]);
}
    
function editChannel(e) {
   var channelId = e.context; 
   var dataSource = APP.models.channels.channelsDS;
    dataSource.filter( { field: "channelId", operator: "eq", value: channelId });
    var view = dataSource.view();
    var channel = view[0];
    dataSource.filter([]);
    
    APP.models.channels.currentModel = channel;
    APP.models.channels.currentChannel.unbind('change', syncCurrentChannel);
    APP.models.channels.currentChannel.set('channelId', channel.channelId);
    APP.models.channels.currentChannel.set('name', channel.name);
    APP.models.channels.currentChannel.set('description', channel.description);
    APP.models.channels.currentChannel.set('expirationDate', channel.expirationDate);
    APP.models.channels.currentChannel.set('media', channel.media);
    APP.models.channels.currentChannel.set('archive', channel.archive);
    APP.models.channels.currentChannel.bind('change', syncCurrentChannel);
    
    APP.kendo.navigate('#editChannel');
}
    
function eraseChannel(e) {
    var channelId = e.context;  
}

function archiveChannel(e) {
    var channelId = e.context; 
}
    
function deleteChannel (e) {
   var channelId = e.context;  
    var dataSource = APP.models.channels.channelsDS;
    dataSource.filter( { field: "channelId", operator: "eq", value: channelId });
    var view = dataSource.view();
    var channel = view[0];
    dataSource.remove(channel); 
    deleteParseObject("channels", 'channelId', channelId);
     mobileNotify("Removed channel : " + channel.get('name'));
}
    
function onInitChannels (e) {
    e.preventDefault();
    // ToDo: Initialize list view
    
     $("#channels-listview").kendoMobileListView({
        dataSource: APP.models.channels.channelsDS,
        template: $("#channels-listview-template").html()
    });
}

function onInitChannel (e) {
    e.preventDefault();
    var params = e.view.params;
    // ToDo: Initialize list view
}
    
function requestBeta (e) {
    e.preventDefault();
    if (APP.models.sync.requestActive) {
        mobileNotify("Processing current request.")
        return;
    }
    APP.models.sync.requestActive = true;
    var userUUID = null, name = null, email = null, phone = null;
    mobileNotify("Preparing your beta request");
    
    if (APP.models.profile.parseUser === null) { 
        mobileNotify("You must be a user to join iPhone beta");
        return;
    } else {
        userUUID = APP.models.profile.currentUser.get('userUUID');
        name = APP.models.profile.currentUser.get('name');
        email = APP.models.profile.currentUser.get('email');
        phone = APP.models.profile.currentUser.get('phone');
    }
    
    var Beta = Parse.Object.extend('betarequest');
    var beta = new Beta();
    beta.set("userUUID", userUUID);
    beta.set("name", name);
    beta.set("email",email );
    beta.set("phone", phone);
    beta.set("udid", APP.models.profile.udid);
    beta.set("device", APP.models.profile.device);
    beta.set("model", APP.models.profile.model);
    beta.set("platform", APP.models.profile.platform);
    
    beta.save(null, {
        success: function(support) {
            mobileNotify("You beta request was sent. Thank you!");
            APP.models.sync.requestActive = false;
        },
        error: function(support, error) {
            mobileNotify("Error sending your beta request: " + error);
            APP.models.sync.requestActive = false;
        }
    })
}
    
function sendSupportRequest(e) {
    e.preventDefault();
    if (APP.models.sync.requestActive){
        mobileNotify("Processing current support request.")
        return;
    }
        
    APP.models.sync.requestActive = true;
    var category = $('#supportCategory').val(), message =  $('#supportMessage').val();
    var userUUID = null, name = null, email = null, phone = null;
    mobileNotify("Preparing your support request");
    
   if (APP.models.profile.parseUser !== null) {
        userUUID = APP.models.profile.currentUser.get('userUUID');
        name = APP.models.profile.currentUser.get('name');
        email = APP.models.profile.currentUser.get('email');
        phone = APP.models.profile.currentUser.get('phone');
    }
    
    var Support = Parse.Object.extend('support');
    var support = new Support();
    support.set("userUUID", userUUID);
    support.set("name", name);
    support.set("email",email );
    support.set("phone", phone);
    support.set("category", category);
    support.set("message", message);
    support.set("udid", APP.models.profile.udid);
    support.set("device", APP.models.profile.device);
    support.set("model", APP.models.profile.model);
    support.set("platform", APP.models.profile.platform);
    
    support.save(null, {
        success: function(support) {
            mobileNotify("You support request was sent. Thank you!");
            closeModalViewSupport();
            APP.models.sync.requestActive = false;
        },
        error: function(support, error) {
            mobileNotify("Error sending your support request: " + error);
            APP.models.sync.requestActive = false;
        }
    })
}
    
function introChanging () {
    $('.intro-photo-block').removeClass('animated fadeIn');
    $('.intro-photo-block').addClass('hidden');
}

function introChanged () {
    $('.intro-photo-block').removeClass('hidden');
    $('.intro-photo-block').addClass('animated fadeIn');
}
    
    
</script>

</head>
<body id="body">
 
<div data-role="layout" data-id="main" style="display:none;">
    <div data-role="header">
        <div data-role="navbar">
            <span data-role="view-title"></span>
            <a data-role="button" href="#appDrawer" data-rel="drawer" data-align="left" > <i class="ghostIconNavbar fa fa-bars"></i> </a>
          
        </div>
    </div>

    <div data-role="content" class='view-content'>
    <!-- application views will be rendered here -->
    </div>

</div>

 <div data-role="layout" data-id="profileLayout" style="display:none;">
    <div data-role="header">
        <div data-role="navbar">
            <span data-role="view-title"></span>
            <a data-role="button" href="#appDrawer" data-rel="drawer" data-align="left" ><i class="ghostIconNavbar fa fa-bars"></i></a>
        </div>
    </div>

    <div data-role="content" class='view-content'>
    <!-- application views will be rendered here -->
    </div>

</div>
    
<div data-role="layout" data-id="newuser" style="display:none">
    <div data-role="header">
       
    </div>

    <div data-role="content" class='view-content'>
    <!-- application views will be rendered here -->
    </div>

</div>
    
 <div data-role="layout" data-id="addcontacts" style="display:none">
    <div data-role="header">
      <div data-role="navbar">
            <a class="nav-button" data-align="left" data-role="backbutton">Back</a>
            <span data-role="view-title"></span>
            <a data-align="right" data-role="button"  data-click="contactsAddContact"><i class="ghostIconNavbar fa fa-plus"></i></a>
        </div>
    </div>

    <div data-role="content" class='view-content'>
    <!-- application views will be rendered here -->
    </div>

</div>


  <!-- application drawer and contents -->
 <div data-role="drawer" id="appDrawer" style="width: 180px" data-title="Main Menu" data-swipe-to-open="false" style="display:none;">
    <div data-role="header">
      <div data-role="navbar">
        <span data-role="view-title"></span>
      </div>
    </div>
    <ul data-role="listview" style="font-size: 1.1em;">
      <li>
        <a href="#home"> <i class="ghostIconSmall fa fa-home"></i> Home</a>
      </li>
      <li>
        <a href="views/profile.html"> <i class="ghostIconSmall fa fa-user"></i> Profile</a>
      </li>
     <li>
        <a href="views/contacts.html"> <i class="ghostIconSmall fa fa-users"></i> Contacts</a>
      </li>
      <li>
        <a href="views/channels.html"> <i class="ghostIconSmall fa fa-comment-o"></i> Channels</a>
      </li>
       <li>
        <a href="views/gallery.html"> <i class="ghostIconSmall fa fa-photo"></i> Gallery</a>
      </li>
     <li>
        <a href="views/places.html"> <i class="ghostIconSmall fa fa-map-marker"></i> Places</a>
      </li>
        <li>
        <a href="#modalview-support" data-rel="modalview"> <i class="ghostIconSmall fa fa-question"></i> Contact Support</a>
      </li>
    </ul>
  </div>       
    
<!-- home - for signed in users -->
<div data-role="view" data-title="ghostgrams" id="home" data-layout="main" data-model="APP.models.home" style='display:none;'>
   <div data-role="header">
      <div data-role="navbar">
        <a data-role="button" href="#appDrawer" data-rel="drawer" data-align="left" > <i class="ghostIconNavbar fa fa-bars"></i> </a>
        <span data-role="view-title"></span>
        <a  data-click="homeSignout" data-role="button" data-align="right">Sign Out</a>
      </div>
    </div>
    
    <div class="user-content">
        <div >
           <div  style='padding-top: 24px; padding-bottom: 28px; font-size: 24px; text-align: center; color: #aeaeae'> Personal, private, secure</div>
       </div>
        
        <ul data-role="listview" id="notification-list" data-source="APP.models.home.notificationDS"  data-template="notification-template">
                 
        </ul>
    </div>

</div>
    
<script type="text/x-kendo-template" id="notification-template">      
    <div>
        <div class="ghostTitle"> <span> #=title# </span>  <span style="float: right;"> #=date# </span> </div>
        <div style="clear: both;" class="ghostDescription"> #=description# </div>
        # if (action !== null) {#  <a data-action="#=action#"> #=actionTitle# </a> #} else if (href !== null) {# <a href="#=href#"> #=actionTitle# </a>#}#
    </div>
</script> 
    
<!-- home - for new users -->
 <div data-role="view" data-title="ghostgrams" id='newuserhome' data-layout="newuser" data-model="APP.models.home" class='appearance' style='display:none;'>
   <div >
       <div  style='padding-top: 24px; padding-bottom: 28px; font-size: 24px; text-align: center; color: #aeaeae'>  Personal, private, secure</div>
   </div>
    

    <div id="home-signin">
         <div style='clear:both; padding-top: 28px; padding-left:12px;text-align:center;'>
            <span class="ghostWhiteTitle" >Don't have an Account? </br> Sign Up Now!</span>
        </div>
        <div style='clear:both; padding-top: 12px; padding-bottom: 28px; text-align: center;' >
            <a style="font-size: 1.3em;" class="button ghostButton" id="home-signup" data-role="button" data-rel="modalview" href="#modalview-signup" >Sign Up</a>
        </div>
         
        
        <div style='padding-top: 12px; padding-left:12px; padding-bottom: 12px;  text-align: center;'> <span class="ghostWhiteTitle"> Get your ghost on!!!</span></div>

        <div style="text-align: center;"> 
            <a  style="font-size: 1.3em;" class="button ghostButton"  data-rel="modalview" href="#modalview-login" data-role="button">Sign In</a>
        </div>

        <div style='padding-top: 32px; padding-left:12px; padding-bottom: 4px;  text-align: center;'> <span class="ghostWhiteTitle">Having trouble Signing In?</span></div>

        <div style="padding-top: 8px; text-align: center;">
            <a style="font-size: 0.9em;" class="button ghostButton" data-rel="modalview" href="#modalview-recoverPassword" data-role="button">Recover your Password?</a>
        </div>
        
       
    </div>
</div>

<div data-role="modalview" id="modalview-support" style="width: 90%; display: none;" class="appearance">
    <div data-role="header">
        <div data-role="navbar">
            <span>Contact ghostgrams</span>
            
        </div>
    </div>

     <form>
        <ul data-role="listview" data-style="inset">
            <li>
                <label>Topic
                    <select id="supportCategory">
                        <option value="installation">Installation</option>
                        <option value="login">Sign In or Sign Up</option>
                         <option value="verification">Verification</option>
                        <option value="ios">iPhone iOS</option>
                        <option value="android">Android Phones</option>
                        <option value="bug">Software Bug</option>
                        <option value="feature">Feature Request</option>
                        <option value="other">Other</option>
                    </select>
                </label>
            </li>
            <li>
                <label>Message
                <textarea id="supportMessage" style="height:120px;"></textarea>
            </li>
        </ul>
    </form> 
    <div data-role="footer">
        <div data-role="navbar">
            <a data-click="closeModalViewSupport;" data-role="button" data-align="left">Cancel</a>
            <a data-click="sendSupportRequest"  type="button" data-role="button" data-align="right">Send</a>
        </div>
    </div>
</div>
    
<div data-role="modalview" id="modalview-verifyPhone" style="width: 90%; display: none;" class="appearance">
    <div data-role="header">
        <div data-role="navbar">
            <span>Verify Phone</span>
            
        </div>
    </div>

     <form>
        <ul data-role="listview" data-style="inset">
            <li>
                <label>Verification Code
                    <input type="number" id="verifyPhone-code" value="" />
                </label>
            </li>
            
        </ul>
    </form> 
    <div data-role="footer">
        <div data-role="navbar">
            <a data-click="closeModalViewVerifyPhone" data-role="button" data-align="left">Cancel</a>
            <a data-click="verifyPhone"  type="button" data-role="button" data-align="right">Verify</a>
        </div>
    </div>
</div>


<div data-role="modalview" id="modalview-login" style="width: 90%; display: none;" class="appearance">
    <div data-role="header">
        <div data-role="navbar">
            <span>Sign In</span>
            
        </div>
    </div>

     <form>
        <ul data-role="listview" data-style="inset">
            <li>
                <label>Username
                    <input type="text" id="home-signin-username" value="" />
                </label>
            </li>
            <li>
                <label>Password
                <input type="password" id="home-signin-password" value="" />
                </label>
            </li>
        </ul>
    </form> 
    <div data-role="footer">
        <div data-role="navbar">
            <a data-click="closeModalViewLogin" data-role="button" data-align="left">Cancel</a>
            <a data-click="homeSignin" id="modalview-login-button" type="button" data-role="button" data-align="right">Sign In</a>
        </div>
    </div>
</div>
    
<div data-role="modalview" id="modalview-signup" style="width: 90%; display: none;" class="appearance" >
    <div data-role="header">
        <div data-role="navbar">
            <span>Create Account</span>
        </div>
    </div>
   <form>
        <ul data-role="listview" data-style="inset">
            <li>
                <label>Username (Email address)
                    <input type="email" id="home-signup-username" value="" />
                </label>
            </li>
             <li>
                <label>Alias (How other users will see you)
                    <input type="text" id="home-signup-alias" value="" />
                </label>
            </li>
            <li>
                <label>Password
                <input type="password" id="home-signup-password" value="" />
                </label>
            </li>
             <li>
                <label>Mobile Phone
                <input type="tel" id="home-signup-phone" value="" />
                </label>
            </li>
        </ul>
    </form> 
    <div data-role="footer">
        <div data-role="navbar">
            <a data-click="closeModalViewSignup" data-role="button" data-align="left">Cancel</a>
            <a data-click="homeCreateAccount" id="home-createAccount" type="button" data-role="button" data-align="right">Sign Up</a>
    </div>
</div>
<div data-role="modalview" id="modalview-recoverPassword" style="width: 90%; display:none;" class="appearance">
    <div data-role="header">
        <div data-role="navbar">
            <span>Recover Password</span>
        </div>
    </div>

     <form>
        <ul data-role="listview" data-style="inset">
            <li>
                <label>Send Recover instructions to: 
                    <input type="text" id="home-recoverPassword-email" value="" />
                </label>
            </li>
        </ul>
    </form> 
    <div data-role="footer">
        <div data-role="navbar">
            <a data-click="closeModalViewRecoverPassword" data-role="button" data-align="left">Cancel</a>
            <a data-click="homeRecoverPassword" id="modalview-recoverPassword-button" type="button" data-role="button" data-align="right">Recover Password</a>
        </div>
    </div>
</div>
    

    
<script type="text/x-kendo-tmpl" id="gallery-listview-template">
<div>

</div>
</script>

</body>
</html>
