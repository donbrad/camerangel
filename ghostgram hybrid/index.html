<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="utf-8" />
    <!-- Styles -->
    <link href="kendo/styles/kendo.mobile.all.min.css" rel="stylesheet" />
    <link href="kendo/styles/kendo.dataviz.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="styles/font-awesome.css">
    <link href="styles/main.css" rel="stylesheet" />
 <!-- External scripts -->
    <script src="cordova.js"></script>
    <script src="kendo/js/jquery.min.js"></script>
    <script src="kendo/js/kendo.mobile.min.js"></script>
	<script src="scripts/parse.js"></script>
    <script src="https://cdn.pubnub.com/pubnub-dev.js"></script>
    <script src="scripts/appData.js"></script>
    <script src="scripts/app.js"></script>
    <script src="scripts/guid.js"></script>
    <script src="scripts/uuid.js"></script>
    
<script>

function togglePrivate (e) {
    e.preventDefault();
    var privateMode = !APP.models.home.privateMode;
    APP.models.home.privateMode = privateMode;
    if (privateMode) {
        $('.privateModeButton').text('Private');
        $('.user-content').removeClass('publicMode');
        $('.user-content').addClass('privateMode');

    } else {
        $('.privateModeButton').text('Public');
        $('.user-content').addClass('publicMode');
        $('.user-content').removeClass('privateMode');
    }
}

function beforeShowFilter() {

    if (APP.models.home.privateMode) {
        $('.privateModeButton').text('Private');
        $('.user-content').removeClass('publicMode');
        $('.user-content').addClass('privateMode');

    } else {
        $('.privateModeButton').text('Public');
        $('.user-content').addClass('publicMode');
        $('.user-content').removeClass('privateMode');
    }   

    $(".user-content").kendoTouch({
        touchstart: function(e) {
            e.preventDefault();
            if (!APP.models.home.privateMode)
                return;
             $('.user-content').addClass('publicMode');
             $('.user-content').removeClass('privateMode');
        },
        dragend: function(e) {
            e.preventDefault();
             if (!APP.models.home.privateMode)
                return;
             $('.user-content').removeClass('publicMode');
             $('.user-content').addClass('privateMode');
        },
    }); 
}

function homeBeforeShow () {

    if (APP.models.profile.currentUser) {
        // Have current user - redirect to user view

        APP.models.profile.username =  APP.models.profile.currentUser.username;
        APP.models.profile.email =  APP.models.profile.currentUser.email;
        APP.models.profile.phone =  APP.models.profile.currentUser.phone;
        APP.models.profile.alias =  APP.models.profile.currentUser.alias;
        APP.models.profile.udid =  APP.models.profile.currentUser.udid;
        APP.models.profile.userUUID = APP.models.profile.currentUser.UUID;
        APP.kendo.navigate('#home');

    } else {
        // No current user -redirect to no user view
       APP.kendo.navigate('#nouser');
    }
} 

function homeSignout (e) {

    e.preventDefault();
    Parse.User.logOut();
    APP.models.profile.currentUser = '';
    APP.models.profile.username =  '';
    APP.models.profile.email =  '';
    APP.models.profile.phone =  '';
    APP.models.profile.alias =  '';
    APP.models.profile.userUUID = '';
    APP.models.profile.parseACL = '';
    APP.kendo.navigate('#newuserhome');
}

function homeSignin (e) {
    e.preventDefault();
    
   Parse.User.logIn($('#home-signin-username').val(), $('#home-signin-password').val(), {
        success: function(user) {
        // Do stuff after successful login.
            closeModalViewLogin();
            APP.models.profile.currentUser = user.attributes;
            APP.models.profile.username =  APP.models.profile.currentUser.username;
            APP.models.profile.email =  APP.models.profile.currentUser.email;
            APP.models.profile.phone =  APP.models.profile.currentUser.phone;
            APP.models.profile.alias =  APP.models.profile.currentUser.alias;
            APP.models.profile.userUUID =  APP.models.profile.currentUser.userUUID;
            APP.models.profile.parseACL = new Parse.ACL(user);
            window.onUserSignIn();
            APP.kendo.navigate('#home');
        },
        error: function(user, error) {
        // The login failed. Check error to see why.
             alert("Error: " + error.code + " " + error.message);
        }
    });
}
   
function closeModalViewLogin() {
    $("#modalview-login").kendoMobileModalView("close");
}

function closeModalViewSignup() {
    $("#modalview-signup").kendoMobileModalView("close");
}

function closeModalViewRecoverPassword() {
    $("#modalview-recoverPassword").kendoMobileModalView("close");
}

function closeModalViewAddChannel() {
    $("#modalview-channels-addChannel").kendoMobileModalView("close");
}

function closeModalViewAddPhoto() {
    $("#modalview-gallery-addPhoto").kendoMobileModalView("close");
}
    
function closeModalViewAddPlace() {
    $("#modalview-places-addPlace").kendoMobileModalView("close");
}

function closeModalViewAddContact() {
    $("#modalview-contacts-addContact").kendoMobileModalView("close");
}

function closeModalViewEditChannel() {
    $("#modalview-channels-editChannel").kendoMobileModalView("close");
}

function updateCurrentContact(e) {
    e.preventDefault();
    APP.models.currentContact.unbind('change');
}

function personalMessage(e) {
    e.preventDefault();
}
    
function onInitContacts(e) {
   e.preventDefault();   
     $("#contacts-listview").kendoMobileListView({
            dataSource: APP.models.contacts.contactsDS,
            template: $("#contactsTemplate").text(),
           filterable: {
                field: "name",
                operator: "startswith"
            },
            click: function(e) {
                e.preventDefault();
                var contact = e.dataItem;
                // Map the stored value to a bindable value for the control
                if (contact.privateChannel)
                    contact.privateChannelBind = 'yes';
                else
                    contact.privateChannelBind = 'no';
                
                // Wish observables set took an object -- need to set fields individually
                APP.models.contacts.currentContact.set('name', contact.name);
                APP.models.contacts.currentContact.set('alias', contact.alias);
                APP.models.contacts.currentContact.set('phone', contact.phone);
                APP.models.contacts.currentContact.set('email', contact.email);
                APP.models.contacts.currentContact.set('privateChannel', contact.privateChannel);
                APP.models.contacts.currentContact.set('privateChannelBind', contact.privateChannelBind);
                APP.models.contacts.currentContact.bind('change', updateCurrentContact);
                
                APP.kendo.navigate("#contactsEditContact");
            }
     });
}
    
    
function onInitContactImport (e) {
    e.preventDefault();
    $("#contactimport-listview").kendoMobileListView({
            dataSource: APP.models.contacts.deviceContactsDS,
            template: $("#deviceContactsTemplate").text(),
            click: function(e) {
               APP.models.contacts.currentDeviceContact = e.dataItem;
               APP.models.contacts.emailArray = new Array();
                
               for (var i = 0; i<APP.models.contacts.currentDeviceContact.emails.length; i++) {
                    var email = new Object();
                    email.name = APP.models.contacts.currentDeviceContact.emails[i].name;
                    email.address =  APP.models.contacts.currentDeviceContact.emails[i].address;

                   APP.models.contacts.emailArray.push(email);

               }

               APP.models.contacts.phoneArray = new Array();
                 for (var j = 0; j<APP.models.contacts.currentDeviceContact.phoneNumbers.length; j++) {
                    var phone = new Object();
                    phone.name = APP.models.contacts.currentDeviceContact.phoneNumbers[j].name;
                    phone.number =  APP.models.contacts.currentDeviceContact.phoneNumbers[j].number;

                   APP.models.contacts.phoneArray.push(phone);

               }
               
               APP.models.contacts.phoneDS.data( APP.models.contacts.phoneArray);
               APP.models.contacts.emailDS.data( APP.models.contacts.emailArray);
               APP.kendo.navigate('#contacts-addContact');
             
            }
    });
}
    
function handleParseError(err) {
  switch (err.code) {
    case Parse.Error.INVALID_SESSION_TOKEN:
     
      Parse.User.logOut();
        APP.models.profile.currentUser = '';
        APP.models.profile.username =  '';
        APP.models.profile.email =  '';
        APP.models.profile.phone =  '';
        APP.models.profile.alias =  '';
        APP.models.profile.userUUID = '';
        APP.kendo.navigate('#newuserhome');
      break;
  }
}
    
function contactsFindContacts(e) {
    e.preventDefault(e);   
    var query = $('#contactSearchQuery').val();
   
    var options      = new ContactFindOptions();
    options.filter   = query
    options.multiple = true;
    var fields       = ["name", "phoneNumbers", "emails"];
     
    navigator.contacts.find(fields, function(contacts){
        
        APP.models.contacts.deviceContactsDS.data([]);
        var contactsCount = contacts.length;
        
        for (var i=0;  i<contactsCount; i++){
            var contactItem = new Object();
            contactItem.type = "device";
            contactItem.name = contacts[i].name.formatted;
            contactItem.phoneNumbers = new Array();
            if (contacts[i].phoneNumbers !== null) {
                for (var j=0; j<contacts[i].phoneNumbers.length; j++){
                    var phone = new Object();
                    phone.name = contacts[i].phoneNumbers[j].type + " : " + contacts[i].phoneNumbers[j].value ;
                    phone.number = contacts[i].phoneNumbers[j].value;
                    contactItem.phoneNumbers.push(phone);
                }
            }
            
            contactItem.emails = new Array();
            if (contacts[i].emails !== null) {
                 for (var k=0; k<contacts[i].emails.length; k++){
                    var email = new Object();
                    email.name = contacts[i].emails[k].type + " : " + contacts[i].emails[k].value;
                    email.address = contacts[i].emails[k].value;
                    contactItem.emails.push(email);
                }
            }
            APP.models.contacts.deviceContactsDS.add(contactItem);
        }
         
    },function(error){alert(error);}, options);
 }
    
function doShowAddContacts() {
    var data = APP.models.contacts.currentDeviceContact;
    
    $("#addContactName").val(data.name);
   
}

function contactsAddContact(e){
    e.preventDefault(e);
     var Contacts = Parse.Object.extend("contacts");
    var contact = new Contacts();
    
    var name = $('#addContactName').val(),
        alias = $('#addContactAlias').val(),
        phone = $('#addContactPhone').val(),
        email = $('#addContactEmail').val(), 
        private = $('#addContactPrivate').val();
        guid = uuid.v4();
        
    contact.set("name", name );
    contact.set("alias", alias);
    contact.set("phone", phone);
    contact.set("email", email);
    contact.set("privateChannel", private === 'yes' ? true : false);
    contact.set("uuid", guid);
    
    contact.setACL(APP.models.profile.parseACL);
    contact.save(null, {
      success: function(contact) {
        // Execute any logic that should take place after the object is saved.
        alert('Created contact : ' + contact.get('name'));
        APP.models.contacts.contactsDS.add(contact.attributes);
        APP.kendo.navigate('#contactImport');
          
      },
      error: function(contact, error) {
        // Execute any logic that should take place if the save fails.
        // error is a Parse.Error with an error code and message.
          handleParseError(error);
       
      }
    });
 
    
}
    
function contactsPickContact(e) {
    e.preventDefault(e);
    navigator.contacts.pickContact(function(contact){
       alert(JSON.stringify(contact));
    },function(err){
        alert('Error: ' + err);
    });
}
    
function homeCreateAccount(e) {
    e.preventDefault();

    var user = new Parse.User();
    var username = $('#home-signup-username').val();
    var password = $('#home-signup-password').val();
    var phone = $('#home-signup-phone').val();
    var alias = $('#home-signup-alias').val();

    var userUUID = uuid.v4();
    
    //Todo: add validation for user entry and prior to parse call
    user.set("username", username);
    user.set("password", password);
    user.set("email", username);
    user.set("phone", phone);
    user.set("alias", alias);
    user.set("phoneVerified", false);
    user.set("userUUID", userUUID);

    APP.models.profile.username = username;
    APP.models.profile.email = username;
    APP.models.profile.phone = phone;
    APP.models.profile.alias = alias;
    APP.models.profile.userUUID = userUUID;
    
    user.signUp(null, {
        success: function(user) {
            // Hooray! Let them use the app now.
           closeModalViewSignup();
            APP.models.profile.parseACL = new Parse.ACL(Parse.User.current());
           alert('Welcome to ghostgrams!');
           APP.kendo.navigate('#home');
        },

        error: function(user, error) {
        // Show the error message somewhere and let the user try again.
        alert("Error: " + error.code + " " + error.message);
        }
    });
}

function onInitGallery(e){
    e.preventDefault();
    // ToDo: Initialize list view
    
     $("#gallery-listview").kendoMobileListView({
        dataSource: APP.models.gallery.galleryDS,
        template: $("#gallery-listview-template").text(),
        filterable: {
            field: "name",
            operator: "startswith"
        },
        endlessScroll: true
    }); 
}

function channelsAddChannel(e) {
    e.preventDefault();

    var Channels = Parse.Object.extend("channels");
    var channel = new Channels();
    
    var name = $('#channels-addChannel-name').val(),
        moderated = $('#channels-addChannel-moderated').val(),
        expirationDate = $('#channels-addChannel-expirationDate').val(),
        description = $('#channels-addChannel-description').val(), 
        guid = uuid.v4()
        
    channel.set("name", name );
    channel.set("isOwner", true);
    channel.set("moderated",  moderated === "channelModerated" ? true : false);
    channel.set("expirationDate", expirationDate);
    channel.set("description", description);
    channel.set("channelId", guid);
    
    channel.setACL(APP.models.profile.parseACL);
    channel.save(null, {
      success: function(channel) {
        // Execute any logic that should take place after the object is saved.
        //alert('Created channel : ' + channel.get('name'));
          APP.models.channels.channelDS.add(channel.attributes);
          closeModalViewAddChannel();
      },
      error: function(channel, error) {
        // Execute any logic that should take place if the save fails.
        // error is a Parse.Error with an error code and message.
        alert('Error creating channel: ' + error.message);
        handleParseError(error);
      }
    });
 
}

function onInitChannels (e) {
    e.preventDefault();
    // ToDo: Initialize list view
    
     $("#channels-listview").kendoMobileListView({
        dataSource: APP.models.channels.channelDS,
        template: $("#channels-listview-template").text()
    });
}

function introChanging () {
    $('.intro-photo-block').removeClass('animated fadeIn');
    $('.intro-photo-block').addClass('hidden');
}

function introChanged () {
    $('.intro-photo-block').removeClass('hidden');
    $('.intro-photo-block').addClass('animated fadeIn');
}
</script>

</head>
<body id="body">
 
<div data-role="layout" data-id="main" style="display:none;">
    <div data-role="header">
        <div data-role="navbar">
            <span data-role="view-title"></span>
            <a data-role="button" href="#appDrawer" data-rel="drawer" data-align="left" > <i class="ghostIconNavbar fa fa-bars"></i> </a>
            <a data-role="button" class="privateModeButton" data-click="togglePrivate" data-align="right" >Public</a>
        </div>
    </div>

    <div data-role="content" class='view-content'>
    <!-- application views will be rendered here -->
    </div>

</div>

 <div data-role="layout" data-id="profileLayout" style="display:none;">
    <div data-role="header">
        <div data-role="navbar">
            <span data-role="view-title"></span>
            <a data-role="button" href="#appDrawer" data-rel="drawer" data-align="left" ><i class="ghostIconNavbar fa fa-bars"></i></a>
        </div>
    </div>

    <div data-role="content" class='view-content'>
    <!-- application views will be rendered here -->
    </div>

</div>
    
<div data-role="layout" data-id="newuser" style="display:none">
    <div data-role="header">
       
    </div>

    <div data-role="content" class='view-content'>
    <!-- application views will be rendered here -->
    </div>

</div>
    
 <div data-role="layout" data-id="addcontacts" style="display:none">
    <div data-role="header">
      <div data-role="navbar">
            <a class="nav-button" data-align="left" data-role="backbutton">Back</a>
            <span data-role="view-title"></span>
            <a data-align="right" data-role="button"  data-click="contactsAddContact"><i class="ghostIconNavbar fa fa-plus"></i></a>
        </div>
    </div>

    <div data-role="content" class='view-content'>
    <!-- application views will be rendered here -->
    </div>

</div>


  <!-- application drawer and contents -->
 <div data-role="drawer" id="appDrawer" style="width: 180px" data-title="Main Menu" data-swipe-to-open="false" style="display:none;">
    <div data-role="header">
      <div data-role="navbar">
        <span data-role="view-title"></span>
      </div>
    </div>
    <ul data-role="listview">
      <li>
        <a href="#home"> <i class="ghostIconSmall fa fa-home"></i> Home</a>
      </li>
      <li>
        <a href="views/profile.html"> <i class="ghostIconSmall fa fa-user"></i> Profile</a>
      </li>
      <li>
        <a href="views/channels.html"> <i class="ghostIconSmall fa fa-comment-o"></i> Channels</a>
      </li>
       <li>
        <a href="views/gallery.html"> <i class="ghostIconSmall fa fa-photo"></i> Gallery</a>
      </li>
      <li>
        <a href="views/contacts.html"> <i class="ghostIconSmall fa fa-users"></i> Contacts</a>
      </li>
     <li>
        <a href="views/places.html"> <i class="ghostIconSmall fa fa-map-marker"></i> Places</a>
      </li>
    </ul>
  </div>       
    
<!-- home - for signed in users -->
<div data-role="view" data-title="ghostgrams" id="home" data-layout="main" data-model="APP.models.home" style='display:none;'>
    <div class="user-content">
        <div >
           <div  style='padding-top: 24px; padding-bottom: 28px; font-size: 24px; text-align: center; color: #aeaeae'> Personal, private, secure</div>
       </div>
        
        <div id="home-list">
                 
        </div>

        <div data-role="footer" id="home-footer">
             <div> 
                <a style="width:98%; padding-left: 12px;" class="ghostButton"  data-click="homeSignout" data-role="button">Sign Out</a>
            </div>

        </div>
    </div>
</div>
    
<!-- home - for new users -->
 <div data-role="view" data-title="ghostgrams" id='newuserhome' data-layout="newuser" data-model="APP.models.home" class='appearance' style='display:none;'>
   <div >
       <div  style='padding-top: 24px; padding-bottom: 28px; font-size: 24px; text-align: center; color: #aeaeae'>  Personal, private, secure</div>
   </div>
    

    <div id="home-signin">
        <div style='padding-top: 12px; padding-left:12px; padding-bottom: 12px;  text-align: center;'> <span class="ghostWhiteTitle"> Get your ghost on!!!</span></div>

        <div> 
            <a style="width:98%;" class="button ghostButton"  data-rel="modalview" href="#modalview-login" data-role="button">Sign In</a>
        </div>

        <div style="padding-top: 8px;">
            <a style="width:98%; font-size: 0.9em;" class="button ghostButton" data-rel="modalview" href="#modalview-recoverPassword" data-role="button">Forgot your Password?</a>
        </div>
        <div style='clear:both; padding-top: 28px; padding-left:12px;text-align:center;'>
            <span class="ghostWhiteTitle" >Don't have an Account? </br> Sign Up Now!</span>
        </div>
        <div style='clear:both; padding-top: 12px;' >
            <a style="width:98%;" class="button ghostButton" id="home-signup" data-role="button" data-rel="modalview" href="#modalview-signup" >Sign Up</a>
        </div>
         
    </div>
</div>



<div data-role="modalview" id="modalview-login" style="width: 90%; display: none;" class="appearance">
    <div data-role="header">
        <div data-role="navbar">
            <span>Sign In</span>
            
        </div>
    </div>

     <form>
        <ul data-role="listview" data-style="inset">
            <li>
                <label>Username
                    <input type="text" id="home-signin-username" value="" />
                </label>
            </li>
            <li>
                <label>Password
                <input type="password" id="home-signin-password" value="" />
                </label>
            </li>
        </ul>
    </form> 
    <div data-role="footer">
        <div data-role="navbar">
            <a data-click="closeModalViewLogin" data-role="button" data-align="left">Cancel</a>
            <a data-click="homeSignin" id="modalview-login-button" type="button" data-role="button" data-align="right">Sign In</a>
        </div>
    </div>
</div>
    
<div data-role="modalview" id="modalview-signup" style="width: 90%; display: none;" class="appearance" >
    <div data-role="header">
        <div data-role="navbar">
            <span>Create Account</span>
        </div>
    </div>
   <form>
        <ul data-role="listview" data-style="inset">
            <li>
                <label>Username (Email address)
                    <input type="email" id="home-signup-username" value="" />
                </label>
            </li>
             <li>
                <label>Alias (How other users will see you)
                    <input type="text" id="home-signup-alias" value="" />
                </label>
            </li>
            <li>
                <label>Password
                <input type="password" id="home-signup-password" value="" />
                </label>
            </li>
             <li>
                <label>Mobile Phone
                <input type="tel" id="home-signup-phone" value="" />
                </label>
            </li>
        </ul>
    </form> 
    <div data-role="footer">
        <div data-role="navbar">
            <a data-click="closeModalViewSignup" data-role="button" data-align="left">Cancel</a>
            <a data-click="homeCreateAccount" id="home-createAccount" type="button" data-role="button" data-align="right">Sign Up</a>
    </div>
</div>
<div data-role="modalview" id="modalview-recoverPassword" style="width: 90%; display:none;" class="appearance">
    <div data-role="header">
        <div data-role="navbar">
            <span>Recover Password</span>
        </div>
    </div>

     <form>
        <ul data-role="listview" data-style="inset">
            <li>
                <label>Send Recover instructions to: 
                    <input type="text" id="home-recoverPassword-email" value="" />
                </label>
            </li>
        </ul>
    </form> 
    <div data-role="footer">
        <div data-role="navbar">
            <a data-click="closeModalViewRecoverPassword" data-role="button" data-align="left">Cancel</a>
            <a data-click="homeRecoverPassword" id="modalview-recoverPassword-button" type="button" data-role="button" data-align="right">Recover Password</a>
        </div>
    </div>
</div>
    
<script type="text/x-kendo-tmpl" id="channels-listview-template">
    <div style="clear:both;">
       <div style="float:right; font-size: 10px;"> <a data-rel="modalview" href="\\#modalview-channels-editChannel" data-role="button"><i class="ghostIconSmall fa fa-edit"></i></a> </div>
       <div class="ghostTextLarge"><a>#:name#</a></div>
       <div class="ghostDescription" style="padding-top: 8px; padding-bottom: 12px;"> #: description # </div>
        <div style="font-size: 12px;">
           <span style="float: left;"> # if (moderated) { # Moderated by Creator # } else { # Not Moderated # }#</span>
           <span style="float: right;">Expires: #: expirationDate #</span>
        </div>
    </div>
</script>
    
<script type="text/x-kendo-tmpl" id="gallery-listview-template">
<div>

</div>
</script>

</body>
</html>
