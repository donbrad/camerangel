"use strict";var channelsView={_viewInitialized:!1,_showDeletedChannels:!1,_channelListDS:new kendo.data.DataSource({offlineStorage:"channellist",sort:{field:"lastAccess",dir:"desc"}}),onInit:function(e){e.preventDefault(),$("#channels-listview").kendoMobileListView({dataSource:channelsView._channelListDS,template:$("#channels-listview-template").html(),dataBound:function(e){ux.checkEmptyUIState(channelsView._channelListDS,"#channelListDiv")}}).kendoTouch({filter:".chat-mainBox",enableSwipe:!0,tap:function(e){var a=$(e.sender.events.currentTarget);if(a.hasClass("chat-mainBox")===!0||"chat-mainBox"===e.target[0].className){var n=a.context.parentElement.id,t="#channel?channelId="+n;APP.kendo.navigate(t)}},swipe:function(e){var a=e.sender.events.currentTarget;if("left"===e.direction){var n=$(".chat-active");$(n).velocity({translateX:"0"},{duration:"fast"}).removeClass("chat-active"),$(a).hasClass("private")&&$(window).width()<375?$(a).velocity({translateX:"-45%"},{duration:"fast"}).addClass("chat-active"):$(window).width()<375&&$(a).hasClass("owner")?$(a).velocity({translateX:"-60%"},{duration:"fast"}).addClass("chat-active"):$(window).width()<375?$(a).velocity({translateX:"-45%"},{duration:"fast"}).addClass("chat-active"):$(a).hasClass("private")?$(a).velocity({translateX:"-40%"},{duration:"fast"}).addClass("chat-active"):$(a).hasClass("owner")?$(a).velocity({translateX:"-55%"},{duration:"fast"}).addClass("chat-active"):$(a).velocity({translateX:"-40%"},{duration:"fast"}).addClass("chat-active")}"right"===e.direction&&$(a).hasClass("chat-active")&&$(a).velocity({translateX:"0"},{duration:"fast"}).removeClass("chat-active")}}),ux.checkEmptyUIState(channelsView._channelListDS,"#channels")},updateChannelListDS:function(){if(channelsView._showDeletedChannels)channelsView._channelListDS.data(channelModel.channelsDS.data());else{var e=channelModel.channelsDS,a=e.filter();void 0===a&&(a={}),e.filter({field:"isDeleted",operator:"eq",value:!1});var n=e.view();channelsView._channelListDS.data(n),e.filter(a)}},onShow:function(e){_preventDefault(e),channelsView.updateChannelListDS(),channelsView._viewInitialized||(channelsView._viewInitialized=!0,$("#channels .gg_mainSearchInput").on("input",function(e){var a=this.value;a.length>0?(channelsView._channelListDS.filter([{field:"name",operator:"contains",value:a},{field:"description",operator:"contains",value:a}]),$("#channels .enterSearch").removeClass("hidden")):(channelsView._channelListDS.filter({}),$("#channels .enterSearch").addClass("hidden"))}),$("#channels .enterSearch").on("click",function(){$("#channels .gg_mainSearchInput").val(""),channelsView._channelListDS.filter({}),$(this).addClass("hidden")})),$("#channels .gg_mainSearchInput").attr("placeholder","Search chats..."),ux.checkEmptyUIState(channelsView._channelListDS,"#channels"),ux.showActionBtn(!0,"#channels","#addChannel"),ux.showActionBtnText("#channels","3em","New Chat")},onHide:function(){ux.showActionBtn(!1,"#channels"),ux.hideSearch()},queryChannel:function(e){if(void 0!==e){var a=channelsView._channelListDS,n=a.filter();void 0===n&&(n={}),a.filter(e);var t=a.view(),i=t[0];return a.filter(n),i}},findChannelModel:function(e){return channelsView.queryChannel({field:"channelId",operator:"eq",value:e})},editChannel:function(e){void 0!==e&&void 0!==e.preventDefault&&e.preventDefault();var a=e.button[0].attributes["data-channel"].value;APP.kendo.navigate("#editChannel?channel="+a)},deleteChannel:function(e){e.preventDefault();var a=e.button[0].attributes["data-channel"].value,n=channelsView.findChannelModel(a);channelsView._channelListDS.remove(n),channelModel.deleteChannel(a)},muteChannel:function(e){e.preventDefault();var a=e.button[0].attributes["data-channel"].value,n=channelModel.findChannelModel(a),t=channelsView.findChannelModel(a);t.set("isMuted",n.isMuted),n.isMuted?(channelModel.muteChannel(a,!1),mobileNotify(n.name+" is unmuted")):(channelModel.muteChannel(a,!0),mobileNotify(n.name+" is muted"))}},addChannelView={onInit:function(e){_preventDefault(e),$("#channels-addChannel-name").keyup(function(){""!==$("#channels-addChannel-name").val&&($("#addChat-createBtn").velocity({opacity:1},{duration:500,easing:"spring"}),$("#channels-addChannel-name").unbind()),$("#addChat-helper-1").velocity("fadeOut",{duration:300})})},onShow:function(e){_preventDefault(e),0===contactModel.totalContacts()?($("#addChatNoContacts").removeClass("hidden"),$("#addChatHasContacts").addClass("hidden")):($("#addChatNoContacts").addClass("hidden"),$("#addChatHasContacts").removeClass("hidden")),$(".addChannelEvent").addClass("hidden"),$("#channels-addChannel-description").css("display","none"),$("#addChat-step2").css("opacity",0)},onHide:function(e){_preventDefault(e),addChannelView.resetUI()},addChannel:function(e){if(_preventDefault(e),""!==$("#channels-addChannel-name").val()){var a=$("#channels-addChannel-name").val(),n=$("#channels-addChannel-archive").val(),t=$("#channels-addChannel-description").val();channelModel.findChannelByName(a)?mobileNotify('There is already a chat named : "'+a+'"'):channelModel.addChannel(a,t)}else mobileNotify("Chat name is required")},showChatDescription:function(e){_preventDefault(e),$("#channels-addChannel-description").velocity("slideDown",{duration:1500,easing:"spring",display:"block"}),$("#addChatDescription").velocity("fadeOut")},resetUI:function(e){_preventDefault(e),$("#channels-addChannel-description").css("display","none"),$("#channels-addChannel-description, #channels-addChannel-name").val(""),$("#addChatDescription").velocity("fadeIn"),$("#channels-addChannel-name").keyup(function(){""!==$("#channels-addChannel-name").val&&($("#addChat-createBtn").velocity({opacity:1},{duration:500,easing:"spring"}),$("#channels-addChannel-name").unbind())}),addChannelView.addChatStep1()},addChatStep1:function(e){_preventDefault(e),$("#chat-title-setup").velocity("slideUp",{duration:300}),$("#addChat-step2").velocity("fadeOut",{duration:200}),$("#addChat-step1").velocity("fadeIn",{duration:200,delay:200})},addChatStep2:function(e){if(_preventDefault(e),""!==$("#channels-addChannel-name").val()){var a=$("#channels-addChannel-name").val();$("#chat-title-step1").empty().prepend("+ "+a),$("#chat-title-setup").velocity("slideDown",{display:"block",duration:500}),$("#addChat-step1, #addChat-helper1").velocity("fadeOut",{duration:300}),$("#addChat-step2").velocity("fadeIn",{duration:100,delay:300,display:"block"})}else mobileNotify("Chat name is required")},doShowEventInputs:function(e){_preventDefault(e),$(".addChannelEvent").removeClass("hidden")}},editChannelView={_activeChannelId:null,_activeChannel:new kendo.data.ObservableObject,potentialMembersDS:new kendo.data.DataSource({sort:{field:"name",dir:"asc"}}),membersDS:new kendo.data.DataSource({sort:{field:"name",dir:"asc"}}),originalMembers:[],membersAddedDS:new kendo.data.DataSource,membersDeletedDS:new kendo.data.DataSource,onInit:function(e){_preventDefault(e),editChannelView.membersDS.data([]),editChannelView.potentialMembersDS.data([]),$("#editmembers-listview").kendoMobileListView({dataSource:editChannelView.membersDS,template:$("#editMembersTemplate").html()}),$("#editChannelForm").kendoValidator()},onShow:function(e){if(_preventDefault(e),void 0!==e.view.params.channel){editChannelView._activeChannelId=e.view.params.channel,editChannelView.orginalMembers=[];var a=channelModel.findChannelModel(editChannelView._activeChannelId);editChannelView.setActiveChannel(a);var n=editChannelView._activeChannel.members,t=editChannelView._activeChannel.invitedMembers,i={},s=[],l=contactModel.getPotentialMemberList();if(editChannelView.potentialMembersDS.data(l),editChannelView.membersDS.data([]),editChannelView.membersAddedDS.data([]),editChannelView.membersDeletedDS.data([]),$("#editChannelMemberList").empty(),n.length>0){for(var o=0;o<n.length;o++)i=contactModel.findContact(n[o]),void 0!==i&&(editChannelView.membersDS.add(i),editChannelView.potentialMembersDS.remove(i));if(void 0!==t&&t.length>0)for(var c=0;c<t.length;c++)i=contactModel.findContactByUUID(t[c]),editChannelView.membersDS.add(i),editChannelView.potentialMembersDS.remove(i)}}editChannelView._activeChannel.members.length>0?$(".addChatMembersBanner a").text("+ add new members"):$(".addChatMembersBanner a").text("No one is invited. Tap to add members");var r=$("#editChannel > div.footerBk.km-footer > a.actionBtn.secondary-100.km-widget.km-button > span > p");r.velocity({opacity:1,right:"3rem"},{easing:"spring",delay:500})},setActiveChannel:function(e){editChannelView._activeChannel.set("name",e.name),editChannelView._activeChannel.set("description",e.description),editChannelView._activeChannel.set("isPlace",e.isPlace),editChannelView._activeChannel.set("placeUUID",e.placeUUID),editChannelView._activeChannel.set("placeName",e.placeName),void 0===e.members&&(e.members=[]),editChannelView._activeChannel.set("members",e.members),void 0===e.invitedMembers&&(e.invitedMembers=[]),editChannelView._activeChannel.set("invitedMembers",e.invitedMembers)},validate:function(){var e=$("#editChannelForm").data("kendoValidator");e.validate()&&editChannelView.finalizeEdit()},finalizeEdit:function(e){_preventDefault(e);var a=[],n=[],t=[],i=[],s=editChannelView.membersDS.data(),l=editChannelView._activeChannelId;a.push(userModel.currentUser.userUUID);for(var o=0;o<s.length;o++)null!==s[o].contactUUID?a.push(s[o].contactUUID):(n.push(s[o].uuid),t.push(s[o].phone));editChannelView._activeChannel.members=a;for(var c=editChannelView.membersDeletedDS.data(),r=0;r<c.length;r++){var d=c[r].contactUUID;if(null!==d&&-1==$.inArray(d,a))appDataChannel.groupChannelDelete(d,l,editChannelView._activeChannel.name,editChannelView._activeChannel.name+" has been deleted.");else{var h=editChannelView.membersDeleted[r].phone;void 0!==h&&null!==h&&findUserByPhone(h,function(e){if(e.found){var a=e.user,n=a.get("userUUID");appDataChannel.groupChannelDelete(n,l,editChannelView._activeChannel.name,editChannelView._activeChannel.name+" has been deleted.")}})}}for(var m=editChannelView.membersAddedDS.data(),u=0;u<m.length;u++){var v=null;if(null!==editChannelView._activeChannel.placeUUID){v={chatType:"Place"};var f=placesModel.getPlaceModel(editChannelView._activeChannel.placeUUID),p=new Object(f);v.chatData=p}i.push(m[u].contactUUID),appDataChannel.groupChannelInvite(m[u].contactUUID,l,editChannelView._activeChannel.name,editChannelView._activeChannel.description,a,v)}for(var g=0;g<a.length;g++){var w=-1!==$.inArray(a[g],i);a[g]!==userModel.currentUser.userUUID&&w===!1&&appDataChannel.groupChannelUpdate(a[g],l,editChannelView._activeChannel.name,editChannelView._activeChannel.description,a)}var C=channelModel.findChannelModel(l);C.set("name",editChannelView._activeChannel.name),C.set("description",editChannelView._activeChannel.description),C.set("members",a),C.set("inviteMembers",n),updateParseObject("channels","channelId",l,"name",editChannelView._activeChannel.name),updateParseObject("channels","channelId",l,"description",editChannelView._activeChannel.description),updateParseObject("channels","channelId",l,"members",a),updateParseObject("channels","channelId",l,"invitedMembers",n),$("#showEditDescriptionBtn").velocity("fadeIn"),mobileNotify("Updating "+editChannelView._activeChannel.name),APP.kendo.navigate("#channels"),$("#channels-addChannel-description, #channels-addChannel-name").val("")},deleteMemberBtn:function(e){_preventDefault(e);var a=e.target[0].dataset.id;editChannelView.deleteMember(a)},deleteMember:function(e){var a=contactModel.findContactByUUID(e);editChannelView.membersDeletedDS.add(a),editChannelView.membersAddedDS.remove(a),editChannelView.potentialMembersDS.add(a),editChannelView.potentialMembersDS.sync(),editChannelView.membersDS.remove(a),editChannelView.membersDS.sync(),mobileNotify("Deleted "+a.name)},showDoneButton:function(){},clickEdit:function(e){_preventDefault(e),$(".listTrash").velocity("fadeIn",{duration:100}),$("#editChannel-Trash").velocity("fadeOut",{duration:100}),$("#editChannel-Done").velocity("fadeIn",{delay:100,duration:100}),$(".addChatMembersBanner").velocity("slideUp",{duration:100})},clickDone:function(e){_preventDefault(e),$("#editChannel-Done").velocity("fadeOut",{duration:100}),$(".addChatMembersBanner").velocity("slideDown",{duration:100}),$(".listTrash").velocity("fadeOut",{duration:100}),$("#editChannel-Trash").velocity("fadeIn",{delay:100,duration:100})}},channelMembersView={doInit:function(e){_preventDefault(e),$("#channelMembers-listview").kendoMobileListView({dataSource:editChannelView.potentialMembersDS,template:$("#memberTemplate").html(),filterable:{field:"name",operator:"startswith",placeholder:"Search contacts..."},click:function(e){var a=e.dataItem;editChannelView.membersDS.add(a),null===a.contactUUID?editChannelView._activeChannel.invitedMembers.push(a.uuid):editChannelView._activeChannel.members.push(a.contactUUID),editChannelView.membersDS.sync(),editChannelView.membersAddedDS.add(a),editChannelView.membersDeletedDS.remove(a),editChannelView.potentialMembersDS.remove(a),$(".addedChatMember").text("+ added "+a.name).velocity("slideDown",{duration:300,display:"block"}).velocity("slideUp",{delay:1400,duration:300,display:"none"})}})},doShow:function(e){_preventDefault(e),0===contactModel.totalContacts()&&(mobileNotify("You don't have any contacts yet.  Please add contacts first..."),APP.kendo.navigate("#contacts"))}},channelView={topOffset:0,_active:!1,messageLock:!1,thisUser:null,contactData:[],messagePhotos:[],messageObjects:[],privateContactId:null,privateContact:null,isPrivateChat:!1,privacyMode:!1,currentContact:null,activeMessage:{},intervalId:null,ghostgramActive:!1,sendMessageHandler:null,_offersLoaded:!1,_tagActive:!1,_insertTag:!1,_tagStart:null,_tagEnd:null,_tagRange:null,_firstSpace:!1,membersDS:new kendo.data.DataSource({sort:{field:"name",dir:"asc"}}),members:[],memberList:[],newMembers:[],photoOffersDS:new kendo.data.DataSource({}),photoUrlMap:[],messagesDS:new kendo.data.DataSource({sort:{field:"time",dir:"asc"}}),_channel:null,_channelId:null,queryMessage:function(e){if(void 0!==e){var a=channelView.messagesDS,n=a.filter();void 0===n&&(n={}),a.filter(e);var t=a.view(),i=t[0];return a.filter(n),i}},queryMessages:function(e){if(void 0!==e){var a=channelView.messagesDS,n=a.filter();void 0===n&&(n={}),a.filter(e);var t=a.view();return a.filter(n),t}},isDuplicateMessage:function(e){var a=channelView.queryMessages({field:"msgID",operator:"eq",value:e});return void 0===a?!1:0===a.length?!1:!0},findMessageById:function(e){return channelView.queryMessage({field:"msgID",operator:"eq",value:e})},onInit:function(e){e.preventDefault(),channelView.initDataSources(),$("#messages-listview").kendoMobileListView({dataSource:channelView.messagesDS,template:$("#messagesTemplate").html()}).kendoTouch({filter:"li",enableSwipe:!0,tap:channelView.tapChannel,hold:channelView.holdChannel}),channelView.openEditor()},toggleTool:function(e){},openEditor:function(){$("#messageTextArea").redactor({minHeight:36,maxHeight:360,focus:!0,placeholder:"Message....",buttons:["bold","italic","lists","horizontalrule"],plugins:["bufferbuttons"],toolbarExternal:"#messageComposeToolbar"})},closeEditor:function(){$("#messageComposeToolbar").addClass("hidden")},initDataSources:function(){channelView.messagesDS.data([]),channelView.members=[],channelView.newMembers=[],channelView.memberList=[],channelView.membersDS.data([])},loadImagesThenScroll:function(){var e=$("#messages-listview img"),a=e.length;a>0?(mobileNotify("Loading "+a+" Chat Images..."),e.on("load error",function(){0===--a&&setTimeout(function(){channelView.scrollToBottom()},500)})):setTimeout(function(){channelView.scrollToBottom()},500)},onShow:function(e){_preventDefault(e),$("#messages-listview").data("kendoMobileListView").scroller().reset(),channelView.topOffset=$("#messages-listview").data("kendoMobileListView").scroller().scrollTop,channelView._active=!0,channelView._offersLoaded=!1,ux.showActionBtn(!1,"#channel");var a=e.view.params.channelId;channelView._channelId=a;var n=userModel.currentUser;channelView.initDataSources(),channelView.messageInit(),channelView._initMessageTextArea();var t=channelModel.findChannelModel(a);if(null===t)return void mobileNotify("ChatView -- chat doesn't exist : "+a);channelView._channel=t,channelModel.updateUnreadCount(t.channelId,0,ggTime.currentPubNubTime());var i=null,s=null,l=t.name;if(channelView.members=t.members,channelModel.updateUnreadCount(a,0,null),channelView.privacyMode=!1,$("#privacyMode").html('<img src="images/privacy-off.svg" />'),$("#privacyStatus").addClass("hidden"),$("#channelName").text(l),t.isPrivate){channelView.isPrivateChat=!0,channelView.messageLock=!0,channelView.setMessageLockIcon(channelView.messageLock);var o=t.contactKey;if(void 0===o)return void mobileNotify("No public key for "+t.name);$("#messagePresenceButton").hide();var c=n.publicKey,r=n.privateKey,l=n.name;i=t.channelId,channelView.privateContactId=i;var d=contactModel.findContact(i);if(void 0===d)return void mobileNotify("ChannelView : Undefined contact for "+i);channelView.privateContact=d,l=ux.returnUXPrimaryName(d.name,d.alias),$("#channelName").text(l),$("#channelImage").attr("src",d.photo).removeClass("hidden"),privateChannel.open(n.userUUID,n.alias,l,i,o,channelView.privateContact.name),channelView.messagesDS.data([]),privateChannel.getMessageHistory(function(e){channelView.preprocessMessages(e),t.messagesArray=e,channelView.messagesDS.data(e),channelView.loadImagesThenScroll()})}else $("#channelName").text(l),channelView.isPrivateChat=!1,channelView.messageLock=!1,channelView.setMessageLockIcon(channelView.messageLock),channelView.privateContactId=null,channelView.privateContact=null,channelView.buildMemberDS(),$("#messagePresenceButton").show(),$("#channelImage").attr("src","").addClass("hidden"),groupChannel.open(a,t.name,n.userUUID,n.name,n.alias,n.phone),mobileNotify("Loading Messages..."),channelView.messagesDS.data([]),groupChannel.getMessageHistory(function(e){for(var a=[],n=0;n<e.length;n++){var t=e[n];channelView.isDuplicateMessage(t.msgID)||channelModel.isMessageRecalled(t.msgID)||a.push(t)}channelView.preprocessMessages(a),channelView.messagesDS.data(a),channelView.loadImagesThenScroll()});channelView.updateTimer=setInterval(function(){channelView.updateTimeStamps()},6e4)},preprocessMessages:function(e){for(var a=0;a<e.length;a++){var n=e[a];channelView.preprocessMessage(n)}},preprocessMessage:function(e){var a=channelView.getContactData(e.sender),n=a.uuid,t=a.name,i=a.alias,s=a.photoUrl;e.isContact=a.isContact,e.contactPhotoUrl=s,e.sender===userModel.currentUser.userUUID?e.displayName="Me":e.displayName=ux.returnUXPrimaryName(t,i)},updateTimeStamps:function(){$("#messages-listview").data("kendoMobileListView").refresh(),$("#messages-listview").data("kendoMobileListView").scroller().reset(),channelView.scrollToBottom()},onHide:function(e){channelView._channelId=null,channelView._channel=null,channelView._active=!1,void 0!==channelView.updateTimer&&(clearInterval(channelView.updateTimer),channelView.updateTimer=void 0),channelView.initDataSources(),channelView.messageInit(),channelView.isPrivateChat||groupChannel.close()},findPhotoOffer:function(e){var a=channelView.photoOffersDS,n=a.filter();void 0===n&&(n={}),a.filter({field:"photoId",operator:"eq",value:e});var t=a.view(),i=t[0];return a.filter(n),i},mapPhotoUrl:function(e,a){if(void 0===a||void 0===a.photoId)return"images/photo-default.svg";var n=photoModel.findPhotoById(a.photoId);if(void 0!==n)return n.thumbnailUrl;var t=channelView.findPhotoOffer(a.photoId);return void 0!==t?a.thumbnailUrl:"images/photo-default.svg"},getContactData:function(e){var a={isContact:!0};if(e===userModel.currentUser.userUUID)return a.isContact=!1,a.uuid=userModel.currentUser.userUUID,a.alias=userModel.currentUser.alias,a.name=userModel.currentUser.name,a.photoUrl=userModel.currentUser.photo,(void 0===a.photoUrl||null===a.photoUrl||""===a.photoUrl)&&(a.photoUrl=userModel.identiconUrl),a.publicKey=userModel.currentUser.publicKey,a.isPresent=!0,a;var n=contactModel.inContactList(e);return void 0===n?(a.uuid=e,a.alias="New!",a.name="Chat Member",a.photoUrl="images/ghost-blue.svg",void 0===channelView.newMembers[e]&&(channelView.newMembers[e]=e,mobileNotify("New Chat Member - Looking Up Info..."),contactModel.createChatContact(e,function(e){mobileNotify(e.name+" Added -- Refreshing Chat..."),$("#messages-listview").data("kendoMobileListView").refresh()}))):(a.uuid=n.userUUID,a.alias=n.alias,a.name=n.name,a.photoUrl=n.photo),a},buildMemberDS:function(){channelView.memberList=[],channelView.membersDS.data([]);var e=channelView.members;if(void 0!==e&&null!==e)for(var a=userModel.currentUser.userUUID,n=0;n<e.length;n++){var t={};if(e[n]===a)t.isContact=!1,t.uuid=a,t.contactId=null,t.alias=userModel.currentUser.alias,t.name=userModel.currentUser.name,t.photo=userModel.currentUser.photo,t.publicKey=userModel.currentUser.publicKey,t.isPresent=!0,channelView.memberList[t.uuid]=t;else{var i=contactModel.findContact(e[n]);if(void 0===i){var s=e[n];contactModel.createChatContact(s,function(e){channelView.memberList[s]=e,channelView.membersDS.add(e)})}else t.isContact=!0,t.uuid=e[n],t.contactId=i.uuid,t.alias=i.alias,t.name=i.name,t.photo=i.photo,t.publicKey=i.publicKey,t.isPresent=!1,channelView.memberList[t.uuid]=t,channelView.membersDS.add(t)}}},getUserType:function(e){var a={isContact:!0,alias:"",profileUrl:""}},formatName:function(e){return e.length<16?e:e.substring(0,13)+"..."},archiveMessage:function(e){_preventDefault(e),$(".selectedLI").velocity("slideUp",{delay:150});var a=channelView.currentMessage;null===a&&mobileNotify("No active message!!!");var n=contactModel.findContact(a.sender),t=n.name+" ("+n.alias+")";$("#askRequest-contactName").text(t),$("#modalview-requestContent").data("kendoMobileModalView").open()},findChatMember:function(e){var a=channelView.membersDS,n=a.filter();void 0===n&&(n={}),a.filter({field:"contactUUID",operator:"eq",value:e});var t=a.view(),i=t[0];return a.filter(n),i},onChannelPresence:function(){},setPresence:function(e,a){e===userModel.currentUser.userUUID||channelView.isPrivateChat||channelView.setMemberPresence(e,a)},setMemberPresence:function(e,a){var n=channelView.findChatMember(e);void 0!==n&&n.set("isPresent",a)},updatePresence:function(e,a){$("#occupancyCount").text(a+1);var n=Object.keys(e).length;if(0!==n)for(var t in e){var i=t.username;if(i!==userModel.currentUser.userUUID){var t=channelView.findChatMember(i);(void 0===t||null===t)&&channelView.setPresence(i,!0)}}},activateEditor:function(){$("#messageComposeToolbar").removeClass("hidden"),$("#chat-editorBtnImg").attr("src","images/icon-editor-active.svg")},deactivateEditor:function(){$("#messageComposeToolbar").addClass("hidden"),$("#chat-editorBtnImg").attr("src","images/icon-editor.svg")},ghostgram:function(e){_preventDefault(e),channelView.ghostgramActive=!channelView.ghostgramActive,channelView.ghostgramActive?channelView.activateEditor():channelView.deactivateEditor()},messageInit:function(){channelView.activeMessage={canCopy:!channelView.messageLock,photos:[],objects:[]},channelView.messagePhotos=[],channelView.messageObjects=[],photoModel.initOffer()},messageAddLocation:function(){channelView.activeMessage.geo={lat:mapModel.lat,lng:mapModel.lng},channelView.activeMessage.address=mapModel.currentAddress,null!==userModel.currentUser.currentPlaceId&&(channelView.activeMessage.place={name:userModel.currentUser.currentPlace,uuid:userModel.currentUser.currentPlaceId})},messageAddSmartObject:function(e){channelView.activeMessage.objects.push(e),smartObject.smartAddObject(e)},messageAddPhotoOffer:function(e,a){var n=photoModel.findPhotoById(e);if(void 0!==n)var t={photoId:n.photoId,channelId:channelView._channelId,thumbnailUrl:n.thumbnailUrl,imageUrl:n.imageUrl,canCopy:a,ownerId:n.senderUUID,ownerName:n.senderName};channelView.activeMessage.photos.push(t)},messageAddRichText:function(e){channelView.activeMessage.html=e},messageSend:function(e){_preventDefault(e);var a=!1;channelView.activeMessage={canCopy:!channelView.messageLock,photos:[],objects:[]};var n=$("#messageTextArea").redactor("code.get");n.length>0&&(a=!0),channelView.messageAddLocation(),channelView.messagePhotos.length>0&&(a=!0,channelView.validateMessagePhotos()),channelView.messageObjects.length>0&&(a=!0,channelView.validateMessageObjects()),a===!0&&(channelView._initMessageTextArea(),channelView.isPrivateChat?privateChannel.sendMessage(channelView.privateContactId,n,channelView.activeMessage,86400):groupChannel.sendMessage(n,channelView.activeMessage,86400),channelView.messageInit())},validateMessageObjects:function(){for(var e=[],a=$("#messageTextArea").redactor("code.get"),n=0;n<channelView.messageObjects.length;n++){var t=channelView.messageObjects[n].uuid;-1!==a.indexOf(t)&&channelView.messageAddSmartObject(channelView.messageObjects[n])}},validateMessagePhotos:function(){for(var e=[],a=$("#messageTextArea").redactor("code.get"),n=0;n<channelView.messagePhotos.length;n++){var t=channelView.messagePhotos[n];-1!==a.indexOf(t)&&channelView.messageAddPhotoOffer(t,!channelView.messageLock)}},_checkMessageTextFocus:function(){var e=$("#messageTextArea").redactor("focus.is");e||$("#messageTextArea").redactor("focus.start")},_initMessageTextArea:function(){$("#messageTextArea").redactor("code.set",""),channelView.ghostgramActive&&(channelView.ghostgramActive=!1,channelView.deactivateEditor())},onObjectClick:function(e){_preventDefault(e);var a=e.sender.element[0].attributes["data-objectid"].value,n=null;if(void 0!==e.sender.element[0].parentElement.parentElement.parentElement.parentElement.attributes.id?n=e.sender.element[0].parentElement.parentElement.parentElement.parentElement.attributes.id.value:e.sender.element[0].parentElement.parentElement.parentElement.attributes.id&&(n=e.sender.element[0].parentElement.parentElement.parentElement.attributes.id.value),null===n)return void mobileNotify("Sender deleted this Smart Event!");var t=channelView.findMessageById(n);if(void 0!==t)if(void 0!==t.data.objects&&t.data.objects.length>0){for(var i=t.data.objects,s=null,l=0;l<i.length;l++)i[l].uuid===a&&(s=i[l]);null!==s&&(smartObject.smartAddObject(s),modalActionMeeting.openModal(s))}else mobileNotify("Sender deleted this Smart Event!")},addSmartObjectToMessage:function(e,a){var n=a.date.toLocaleString(),t=moment(n).format("dd MMM Do"),i=moment(n).format("LT"),s='<a class="btnSmart" data-role="button" data-objectid="'+e+'" id="chatobject_'+e+'"data-click="channelView.onObjectClick" ><span class="btnSmart-type"><img src="images/smart-event-light.svg" class="icon-md" /></span><span class="btnSmart-content"><p class="textClamp btnSmart-title">'+a.title+'</p><p class="textClamp btnSmart-date">'+t+" "+i+"</p></span></a>";$("#messageTextArea").redactor("insert.raw",s),a.channelId=channelView._channelId,channelView.messageObjects.push(a)},addImageToMessage:function(e,a){var n=photoModel.findPhotoById(e);if(void 0!==n){var t='<img class="photo-chat" data-photoid="'+e+'" id="chatphoto_'+e+'" src="'+n.thumbnailUrl+'" />';$("#messageTextArea").redactor("insert.raw",t)}channelView.messagePhotos.push(e)},togglePrivacyMode:function(e){_preventDefault(e),channelView.privacyMode=!channelView.privacyMode,channelView.privacyMode?($("#privacyMode").html('<img src="images/privacy-on.svg" />'),$(".chat-message").addClass("privateMode").removeClass("publicMode"),$("#privacyStatus").removeClass("hidden"),kendo.fx($("#privacyStatus")).expand("vertical").play()):($("#privacyMode").html('<img src="images/privacy-off.svg" />'),$(".chat-message").removeClass("privateMode").addClass("publicMode"),$("#privacyStatus").addClass("hidden"))},scrollToBottom:function(){var e=channelView.topOffset;void 0===e&&(e=APP.kendo.scroller().scrollTop);var a=0,n=APP.kendo.scroller().scrollHeight(),t=APP.kendo.scroller().height();n>t&&(a=-1*(n-t-e)),APP.kendo.scroller().scrollTo(0,a)},updateMessageTimeStamps:function(){for(var e=channelView.messagesDS,a=e.total(),n="",t=0;a>t;t++){var i=e.at(t);n=timeSince(i.time),"0 seconds"===n?n="Just now":n+=" ago",i.set("formattedTime",n)}},tapChannel:function(e){e.preventDefault();var a=$(e.touch.initialTouch),n=channelView.messagesDS,t=$(e.touch.currentTarget).data("uid"),i=n.getByUid(t);if(a.hasClass("photo-chat")){var s=a.attr("data-photoId");if(void 0!==i.data.photos)for(var l=i.data.photos,o=0;o<l.length;o++){var c=l[o];if(c.photoId===s)return void modalChatPhotoView.openModal(c)}}channelView.privacyMode&&($("#"+i.msgID).removeClass("privateMode"),$.when(kendo.fx($("#"+i.msgID)).fade("out").endValue(.3).duration(3e3).play()).then(function(){$("#"+i.msgID).css("opacity","1.0"),$("#"+i.msgID).addClass("privateMode")}))},swipeChannel:function(e){e.preventDefault();var a=channelView.messagesDS,n=$(e.touch.currentTarget).data("uid"),t=a.getByUid(n);channelView.privacyMode&&$("#"+t.msgID).removeClass("privateMode");var i=e.sender.events.currentTarget,s=$(i).closest("div"),l=$(s);if(channelView.privacyMode&&$("#"+t.msgID).removeClass("privateMode"),"left"===e.direction){var o=$(".message-active");$(o).velocity({translateX:"0"},{duration:"fast"}).removeClass("message-active"),$(window).width()<375?$(l).velocity({translateX:"-80%"},{duration:"fast"}).addClass("message-active"):$(l).velocity({translateX:"-70%"},{duration:"fast"}).addClass("message-active")}"right"===e.direction&&$(i).hasClass("message-active")&&$(i).velocity({translateX:"0"},{duration:"fast"}).removeClass("message-active")},holdChannel:function(e){e.preventDefault();var a=channelView.messagesDS,n=$(e.touch.currentTarget).data("uid"),t=a.getByUid(n);channelView.activeMessage=t,channelView.privacyMode&&($("#"+t.msgID).removeClass("privateMode"),$.when(kendo.fx($("#"+t.msgID)).fade("out").endValue(.3).duration(3e3).play()).then(function(){$("#"+t.msgID).css("opacity","1.0"),$("#"+t.msgID).addClass("privateMode")})),t.sender===userModel.currentUser.userUUID?$("#messageActionsSender").data("kendoMobileActionSheet").open():t.data.canCopy?$("#messageActions").data("kendoMobileActionSheet").open():mobileNotify("This Message was locked by Sender")},processTag:function(e){var a=e.split(" "),n=smartObject.findTerm(a[0]);if(void 0!==n)switch(n[0].category){case"photo":channelView.processPhotoTag(a);break;case"action":channelView.processActionTag(a,n);break;case"calendar":channelView.processCalendarTag(a,n)}},processPhotoTag:function(e,a){var n=e[0].toLowerCase();switch(e[0]){case"title":var t=e.shift(),i=t.join(" ");break;case"description":var s=e.shift(),l=s.join(" ");break;case"tags":var e=e.shift(),o=e.join(" ")}},processActionTag:function(e,a){var n=e[0].toLowerCase();switch(a[0].type){case"activity":break;case"meeting":break;case"flight":break;case"event":break;case"datejs":break;case"day":break;case"month":break;case"movie":break;case"movies":break;case"time":break;case"tvshow":break;case"tvmovie":}},processCalendarTag:function(e,a){var n=e[0].toLowerCase(),t=/^([0]\d|[1][0-2]):([0-5]\d)\s?(?:AM|PM)$/i},messageRecall:function(e){_preventDefault(e);var a=channelView.activeMessage,n=channelView.memberList,t=Object.keys(n),i=userModel.currentUser.userUUID,s=channelView.findMessageById(a.msgID);if(void 0!==s){for(var l=0;l<t.length;l++){var o=t[l];o!==i&&appDataChannel.recallMessage(o,channelView._channelId,a.msgID,i,channelView.isPrivateChat)}mobileNotify("Recalling message "+a.msgID),channelModel.addMessageRecall(channelView._channelId,a.msgID,i,channelView.isPrivateChat)}},setMessageLockIcon:function(e){e?$("#messageLockButtonIcon").attr("src","images/icon-lock.svg"):$("#messageLockButtonIcon").attr("src","images/icon-unlock.svg")},messageLockButton:function(e){e.preventDefault(),channelView.messageLock=!channelView.messageLock,channelView.setMessageLockIcon(channelView.messageLock)},messageCamera:function(e){_preventDefault(e),devicePhoto.deviceCamera(1600,75,!0,channelView._channelId,channelView.addImageToMessage)},messagePhoto:function(e){_preventDefault(e),
devicePhoto.deviceGallery(1600,75,!0,channelView._channelId,channelView.addImageToMessage)},messageGallery:function(e){_preventDefault(e),galleryPicker.openModal(function(e){var a=e.thumbnailUrl;void 0!==e.imageUrl&&null!==e.imageUrl&&(a=e.imageUrl),channelView.addImageToMessage(e.photoId,a)})},messageAudio:function(e){_preventDefault(e),navigator.device.capture.captureAudio(function(e){var a=e[0].fullPath},function(e){mobileNotify("Audio capture error "+JSON.stringify(e))},{limit:1,duration:5})},messageMenuTag:function(e){var a=$("#messageTextArea").redactor("selection.is");if(a){var n=$("#messageTextArea").redactor("selection.save"),t=$("#messageTextArea").redactor("selection.range",n);channelView._tagRange=t,channelView._tagStart=t.startOffset,channelView._tagEnd=t.endOffset}else channelView._tagStart=$("#messageTextArea").redactor("offset.get"),channelView._tagEnd=channelView._tagStart},messageInsertTag:function(e){_preventDefault(e);var a=$("#messageTextArea").data("kendoEditor"),n=a.getRange();if(channelView._insertTag){$("#chatSmartTagBtn").attr("src","images/icon-smart.svg"),channelView._tagActive=!1,channelView._tagEnd=n.endOffset;var t=a.value(),i=t.substring(channelView._tagStart+1,channelView._tagEnd);mobileNotify("Smart Object: will process "+i),channelView.processTag(i),channelView._insertTag=!1}else a.paste("@"),a.update(),channelView._tagActive=!0,channelView._tagRange=n,channelView._tagStart=n.startOffset,channelView._insertTag=!0,$("#chatSmartTagBtn").attr("src","images/icon-smart-active.svg")},smartScanMessage:function(e){_preventDefault(e),mobileNotify("Smart Scan isn't wired up yet")},messageLocation:function(e){_preventDefault(e),mobileNotify("Chat location isn't wired up yet")},messageCalendar:function(e){_preventDefault(e),channelView.messageMenuTag(),modalActionMeeting.openModal(null)},messageEvent:function(e){_preventDefault(e),mobileNotify("Chat Event isn't wired up yet")},messageFlight:function(e){_preventDefault(e),channelView.messageMenuTag(),mobileNotify("Chat Flight isn't wired up yet")},messageMusic:function(e){_preventDefault(e),mobileNotify("Chat Music isn't wired up yet")},messageMovie:function(e){_preventDefault(e),mobileNotify("Chat Movie isn't wired up yet")}},askRequestModal={close:function(){$("#modalview-requestContent").data("kendoMobileModalView").close()},onSend:function(){askRequestModal.close()},onInit:function(){$("#modalview-requestContent").kendoTouch({enableSwipe:!0,swipe:function(e){e.preventDefault(),$("#modalview-requestContent").data("kendoMobileModalView").close()}})},onOpen:function(){var e=channelView.activeMessage;null===e&&(mobileNotify("No active message!!!"),askRequestModal.close());var a=contactModel.findContact(e.sender),n=a.name+" ("+a.alias+")";$("#askRequest-contactName").text(n)}},channelPresence={_channelId:null,_channelModel:null,onInit:function(e){$("#channelPresence-listview").kendoMobileListView({dataSource:channelView.membersDS,template:$("#chatMemberTemplate").html(),autobind:!1,click:function(e){var a=e.dataItem;void 0!==a&&null!==a.contactId&&(contactActionView.setReturnModal("#channelPresence"),channelPresence.closeModal(),contactActionView.openModal(a.contactId))}})},onShow:function(e){},openModal:function(){$("#channelPresence").data("kendoMobileModalView").open()},closeModal:function(){$("#channelPresence").data("kendoMobileModalView").close()},onDone:function(e){$("#channelPresence").data("kendoMobileModalView").close()},onClose:function(e){}};