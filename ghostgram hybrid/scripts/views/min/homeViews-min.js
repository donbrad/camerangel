"use strict";var userStatusView={_activeStatus:new kendo.data.ObservableObject,_returnView:null,_modalId:"#modalview-profileStatus",_profileStatusMax:35,_update:function(){var e=userStatusView._activeStatus,t=userModel.currentUser;ux.formatNameAlias(t.name,t.alias,"#modalview-profileStatus"),$("#profileStatusMessage").text(t.get("statusMessage")),$("#profileStatusUpdate").val(""),$("#statusCharCount").text(userStatusView._profileStatusMax),t.isAvailable?($(".userAvailable").attr("src","images/status-available.svg"),$(".userAvailableRev").attr("src","images/status-away.svg"),$("#currentAvailableTxt").text("busy")):($(".userAvailable").attr("src","images/status-away.svg"),$(".userAvailableRev").attr("src","images/status-available.svg"),$("#currentAvailableTxt").text("available")),e.set("statusMessage",t.statusMessage),t.isCheckedIn?e.set("currentPlace",t.currentPlace):e.set("currentPlace",""),e.set("isAvailable",t.isAvailable),null!==t.currentPlaceUUID&&t.isCheckedIn?($("#profileCheckOutLi").removeClass("hidden"),$("#checkOut-text").text(t.currentPlace)):($("#profileCheckOutLi").addClass("hidden"),$("#checked-in-place").addClass("hidden"),$("#userStatusLocationBox").addClass("hidden"))},openModal:function(e){_preventDefault(e),userStatusView._returnView=APP.kendo.view().id,userModel.currentUser.isCheckedIn&&null!==userModel.currentUser.currentPlaceUUID?$("#profileLocation, #checked-in-place").removeClass("hidden"):$("#profileLocation, #checked-in-place").addClass("hidden"),$(".statusCharacterCount").css("color","#979797"),mapModel.getCurrentAddress(function(e,t){}),userStatusView._update(),$(userStatusView._modalId).data("kendoMobileModalView").open()},closeModal:function(){$(userStatusView._modalId).data("kendoMobileModalView").close();var e=$("#profileStatusUpdate").val();""!==e&&(userModel.currentUser.set("statusMessage",e),updateParseObject("userStatus","userUUID",userModel.currentUser.uuid,"statusMessage",e)),$("#profileStatusUpdate").val(""),$(".statusCharCount").text(userStatusView._profileStatusMax),null!==userStatusView._returnView&&(APP.kendo.view().id!==userStatusView._returnView&&APP.kendo.navigate("#"+userStatusView._returnView),userStatusView._returnView=null)},openCheckIn:function(e){_preventDefault(e),userStatusView.closeModal(),checkInView.locateAndOpenModal(function(){userStatusView.openModal()})},checkIn:function(e){_preventDefault(e),null!==mapModel.currentPlaceId?(userModel.checkIn(mapModel.currentPlaceId),mapModel.checkIn(mapModel.currentPlaceId),mobileNotify("You're checked in!"),$("#profileCheckOutLi").velocity("slideDown",{begin:function(e){$(e).removeClass("hidden")}})):mobileNotify("No place to check in to...")},checkOut:function(e){_preventDefault(e),$("#profileCheckInLi").removeClass("hidden"),$("#profileCheckOutLi").velocity("slideUp",{complete:function(e){$(e).addClass("hidden")}}),userModel.checkOut(),mapModel.checkOut(),$("#profileStatusCheckInPlace").text("")},syncUserStatus:function(e){_preventDefault(e),userModel.currentUser.set(e.field,this[e.field]),updateParseObject("userStatus","userUUID",userModel.currentUser.uuid,e.field,this[e.field])},onInit:function(e){_preventDefault(e),userStatusView.statusCharCount(e),userStatusView._activeStatus.bind("change",userStatusView.syncUserStatus)},statusCharCount:function(e){var t=userStatusView._profileStatusMax,r;$(".statusCharCount").text(t),$("#profileStatusUpdate").keyup(function(e){var s=$(this).val().length;r=t-s,$(".statusCharCount").text(r),8>r?$(".statusCharacterCount").css("color","#EF5350"):$(".statusCharacterCount").css("color","")})},onOpen:function(e){_preventDefault(e)},onClose:function(e){}},modalView={okAction:null,cancelAction:null,init:function(){modalView.okAction=null,modalView.cancelAction=null,$("#modalCancel").addClass("hidden")},open:function(e,t,r,s,o,a){$("#modalTitle").html(e),null!==t&&$("#modalDescription").html(t),$("#modalOk").html(r),null!==s&&(modalView.okAction=s),null!==a&&(modalView.cancelAction=a),null!==o&&$("#modalCancel").html(o),$("#modalCancel").removeClass("hidden"),$("#modal-dialog").data("kendoMobileModalView").open()},openInfo:function(e,t,r,s){$("#modalTitle").html(e),null!==t&&$("#modalDescription").html(t),$("#modalOk").html(r),null!==s&&(modalView.okAction=s),$("#modalCancel").addClass("hidden"),$("#modal-dialog").data("kendoMobileModalView").open()},close:function(){$("#modal-dialog").data("kendoMobileModalView").close()},okClick:function(){modalView.close(),null!==modalView.okAction&&modalView.okAction(),modalView.init()},cancelClick:function(){modalView.close(),null!==modalView.cancelAction&&modalView.cancelAction(),modalView.init()}},ghostEditView={_callback:null,_returnview:null,onInit:function(e){_preventDefault(e),autosize($("#ghostEmailEditor")),$("#ghostEmailEditor").kendoEditor({tools:["bold","italic","underline","justifyLeft","justifyCenter","justifyRight","insertUnorderedList","indent","outdent","createTable","fontSize",{name:"insertImage",exec:function(e){e.preventDefault(),modalGalleryView.openModal(function(e){$("#ghostEmailEditor").data("kendoEditor").paste('<div style="max-width: 50%; max-height: 50%;>" <img src="'+e+'"/></div>',{split:!0})})}}]})},onShow:function(e){_preventDefault(e),void 0!==e.view.params.callback?ghostEditView._callback=e.view.params.callback:ghostEditView._callback=null,void 0!==e.view.params.returnview?ghostEditView._returnview=e.view.params.returnview:ghostEditView._returnview=null,autosize.update($("#ghostEmailEditor")),$("#ghostEmailEditor").data("kendoEditor").value(""),$("#ghostEmailEditor").data("kendoEditor").focus()},onDone:function(e){_preventDefault(e),null!==ghostEditView._returnview&&APP.kendo.navigate("#"+ghostEditView._returnview),"contactaction"===ghostEditView._callback&&contactActionView.restoreModal()},openModal:function(e){void 0!==e?ghostEditView._callback=e:ghostEditView._callback=null,$("#ghostEmailEditor").data("kendoEditor").value(""),$("#ghostEditModal").data("kendoMobileModalView").open(),$("#ghostEmailEditor").data("kendoEditor").focus()},closeModal:function(e){_preventDefault(e),$("#ghostEditModal").data("kendoMobileModalView").close(),null!==ghostEditView._callback&&ghostEditView._callback()},sendGhostEmail:function(e){_preventDefault(e);var t=$("#ghostEmailEditor").data("kendoEditor").value(),r=contactModel.currentContact.get("publicKey"),s=contactModel.currentContact.get("email");if(window.navigator.simulator===!0)alert("Mail isn't supported in the emulator");else{var o=userModel.currentUser.get("name");cordova.plugins.email.open({to:[s],subject:"ghostgram from "+o,body:t,isHtml:!0},function(e){mobileNotify("Email sent to "+o),ghostEditView.onDone()})}}},editProfilePhotoView={_callback:null,_photoUrl:null,_isUserProfile:!0,_contactId:null,onInit:function(e){_preventDefault(e)},onShow:function(e){_preventDefault(e)},onDone:function(e){},setCallback:function(e){void 0!==e&&(editProfilePhotoView._callback=e)},setPhotoUrl:function(e){editProfilePhotoView._photoUrl=e,$("#profilePhotoImage").attr("src",e)},doCamera:function(e){_preventDefault(e),deviceCamera(1200,75,!1,editProfilePhotoView.setPhotoUrl)},doPhotoGallery:function(e){_preventDefault(e),deviceGallery(1200,75,!1,editProfilePhotoView.setPhotoUrl)},doMemories:function(e){_preventDefault(e),galleryPicker.openModal(function(e){})},updateUserPhotoUrl:function(e){_preventDefault(e),userModel.currentUser.set("photo",editProfilePhotoView._photoUrl)}},signUpView={onInit:function(e){_preventDefault(e),$("#home-signup-phone").keydown(function(e){var t=e.charCode||e.keyCode||0,r=$(this);return 8!==t&&9!==t&&(4===r.val().length&&r.val(r.val()+")"),5===r.val().length&&r.val(r.val()+" "),9===r.val().length&&r.val(r.val()+"-")),8==t||9==t||46==t||t>=48&&57>=t||t>=96&&105>=t}).keyup(function(e){14===$(this).val().length&&(continueSignUp(),$("#home-signup-phone").unbind("keyup"))}).bind("focus click",function(){var e=$(this);if(0===e.val().length)e.val("(");else{var t=e.val();e.val("").val(t)}}).blur(function(){var e=$(this);"("===e.val()&&e.val("")}),$("#create-user-email, #create-user-name, #create-user-alias, #create-user-password").css("display","none")},onSubmit:function(e){e.preventDefault();var t=$("#formCreateAccount").kendoValidator().data("kendoValidator");t.validate()&&signUpView.doCreateAccount()},onShow:function(e){_preventDefault(e)},doCreateAccount:function(e){_preventDefault(e);var t=new Parse.User,r=$("#home-signup-username").val(),s=$("#home-signup-fullname").val(),o=$("#home-signup-password").val(),a=$("#home-signup-phone").val(),n=$("#home-signup-alias").val(),i=uuid.v4();a=unformatPhoneNumber(a),Parse.Cloud.run("validateMobileNumber",{phone:a},{success:function(e){return"ok"!==e.status||"mobile"!==e.result.carrier.type?void mobileNotify("This phone number is not a valid mobile number."):void Parse.Cloud.run("preflightPhone",{phone:a},{success:function(e){return"ok"!==e.status||0!==e.count?void mobileNotify("Your phone number matches existing user."):(t.set("username",r),t.set("password",o),t.set("email",r),t.set("name",s),t.set("phone",a),t.set("alias",n),t.set("aliasPublic","ghostgram user"),t.set("currentPlace",""),t.set("currentPlaceUUID",""),t.set("photo",null),t.set("aliasPhoto",null),t.set("isAvailable",!0),t.set("isVisible",!0),t.set("isCheckedIn",!1),t.set("availImgUrl","images/status-available.svg"),t.set("phoneVerified",!1),t.set("useIdenticon",!0),t.set("useLargeView",!1),t.set("rememberUsername",!1),t.set("userUUID",i),t.signUp(null,{success:function(e){userModel.parseUser=e,userModel.generateUserKey(),userModel.currentUser.set("username",e.get("username")),userModel.currentUser.set("name",e.get("name")),userModel.currentUser.set("email",e.get("email")),userModel.currentUser.set("phone",e.get("phone")),userModel.currentUser.set("alias",e.get("alias")),userModel.currentUser.set("currentPlace",e.get("currentPlace")),userModel.currentUser.set("currentPlaceUUID",e.get("currentPlaceUUID")),userModel.currentUser.set("photo",e.get("photo")),userModel.currentUser.set("isAvailable",e.get("isAvailable")),userModel.currentUser.set("isVisible",e.get("isVisible")),userModel.currentUser.set("isRetina",e.get("isRetina")),userModel.currentUser.set("isWIFIOnly",e.get("isWIFIOnly")),userModel.currentUser.set("isPhotoStored",e.get("isPhotoStored")),userModel.currentUser.set("saveToPhotoAlbum",e.get("saveToPhotoAlbum")),userModel.currentUser.set("aliasPhoto",e.get("aliasPhoto")),userModel.currentUser.set("userUUID",e.get("userUUID")),userModel.currentUser.set("phoneVerified",!1),userModel.currentUser.set("useLargeView",!1),userModel.currentUser.set("useIdenticon",e.get("useIdenticon")),userModel.currentUser.set("emailValidated",e.get("emailVerified")),userModel.generateNewPrivateKey(e),userModel.createIdenticon(i);var t=e.get("photo");(void 0===t||null===t)&&(userModel.currentUser.photo=userModel.identiconUrl),userModel.currentUser.bind("change",userModel.sync),userModel.parseACL=new Parse.ACL(Parse.User.current()),mobileNotify("Welcome to ghostgrams!"),userModel.initPubNub(),window.localStorage.setItem("ggHasAccount",!0),void 0===window.navigator.simulator&&cordova.plugins.notification.local.add({id:"userWelcome",title:"Welcome to ghostgrams",message:"You have a secure connection to your family, friends and favorite places",autoCancel:!0,date:new Date((new Date).getTime()+120)}),Parse.Cloud.run("sendPhoneVerificationCode",{phoneNumber:a},{success:function(e){mobileNotify("Please verify your phone"),$("#modalview-verifyPhone").data("kendoMobileModalView").open()},error:function(e,t){mobileNotify("Error sending verification code "+t)}}),APP.kendo.navigate("#home")},error:function(e,t){mobileNotify("Error: "+t.code+" "+t.message)}}),void 0)},error:function(e){mobileNotify("Error checking phone number"+e)}})},error:function(e){mobileNotify("Error: "+e.code+" "+e.message)}})}},newUserView={onInit:function(e){_preventDefault(e)},onShow:function(e){_preventDefault(e)}},signInView={onInit:function(e){_preventDefault(e),$("#home-signin-username").on("input",function(e){signUpView.checkUserName()}),$("#home-signin-password").on("input",function(e){})},onShow:function(e){_preventDefault(e),userModel.rememberUsername&&""!==userModel.username&&$("#home-signin-username").val(userModel.username)},onClear:function(e){$("#home-signin-username").val(""),$("#home-signin-password").val("")},validate:function(){var e=$("#formSignIn").kendoValidator().data("kendoValidator");e.validate()&&newUserView.doSignIn()},doSignIn:function(){ux.hideKeyboard();var e=$("#home-signin-username").val(),t=$("#home-signin-password").val();mobileNotify("Signing you in to ghostgrams...."),Parse.User.logIn(e,t,{success:function(e){ux.closeModalViewLogin(),window.localStorage.setItem("ggHasAccount",!0),$("#home-signin-username, #home-signin-password").val(""),userModel.parseUser=e,userModel.generateUserKey(),void 0===userModel.parseUser.get("version")&&(userModel.generateNewPrivateKey(userModel.parseUser),userModel.parseUser.set("version",1),userModel.parseUser.save());var t=e.get("publicKey"),r=e.get("privateKey");void 0===t||void 0===r?userModel.generateNewPrivateKey(e):userModel.updatePrivateKey(),userModel.currentUser.set("username",userModel.parseUser.get("username")),userModel.currentUser.set("name",userModel.parseUser.get("name")),userModel.currentUser.set("email",userModel.parseUser.get("email")),userModel.currentUser.set("phone",userModel.parseUser.get("phone")),userModel.currentUser.set("alias",userModel.parseUser.get("alias")),userModel.currentUser.set("aliasPhoto",userModel.parseUser.get("aliasPhoto")),userModel.currentUser.set("statusMessage",userModel.parseUser.get("statusMessage")),userModel.currentUser.set("isAvailable",userModel.parseUser.get("isAvailable")),userModel.currentUser.set("isCheckedIn",userModel.parseUser.get("isCheckedIn")),userModel.currentUser.set("isVisible",userModel.parseUser.get("isVisible")),userModel.currentUser.set("isRetina",userModel.parseUser.get("isRetina")),userModel.currentUser.set("isWIFIOnly",userModel.parseUser.get("isWIFIOnly")),userModel.currentUser.set("isPhotoStored",userModel.parseUser.get("isPhotoStored")),userModel.currentUser.set("saveToPhotoAlbum",userModel.parseUser.get("saveToPhotoAlbum")),userModel.currentUser.set("currentPlace",userModel.parseUser.get("currentPlace")),userModel.currentUser.set("currentPlaceUUID",userModel.parseUser.get("currentPlaceUUID")),userModel.currentUser.set("photo",userModel.parseUser.get("photo")),userModel.currentUser.set("aliasPublic",userModel.parseUser.get("aliasPublic")),userModel.currentUser.set("userUUID",userModel.parseUser.get("userUUID")),userModel.currentUser.set("useIdenticon",userModel.parseUser.get("useIdenticon")),userModel.currentUser.set("useLargeView",userModel.parseUser.get("useLargeView")),userModel.currentUser.set("rememberUsername",userModel.parseUser.get("rememberUsername")),userModel.currentUser.set("publicKey",t),userModel.decryptPrivateKey(),userModel.createIdenticon(userModel.parseUser.get("userUUID"));var s=userModel.parseUser.get("photo");(void 0===s||null===s)&&(userModel.currentUser.photo=userModel.identiconUrl);var o=userModel.parseUser.get("phoneVerified");userModel.currentUser.set("phoneVerified",o),userModel.currentUser.set("availImgUrl","images/status-away.svg");var a=userModel.currentUser.get("isAvailable");a&&userModel.currentUser.set("availImgUrl","images/status-available.svg"),userModel.currentUser.set("emailValidated",userModel.parseUser.get("emailVerified")),userModel.parseACL=new Parse.ACL(userModel.parseUser),userModel.currentUser.bind("change",userModel.sync),userModel.initPubNub(),userModel.fetchParseData(),APP.kendo.navigate("#home"),o?(deviceModel.setAppState("phoneVerified",!0),notificationModel.deleteNotification("phoneVerified")):(mobileNotify("Please verify your phone number"),$("#modalview-verifyPhone").data("kendoMobileModalView").open())},error:function(e,t){mobileNotify("Error: "+t.code+" "+t.message)}})}};