"use strict";var contactsView={onInit:function(t){_preventDefault(t),contactModel.deviceQueryActive=!1,$("#contactsSearchQuery").on("input",function(){var t=this.value;t.length>0?(contactModel.contactListDS.filter({logic:"or",filters:[{field:"name",operator:"contains",value:t},{field:"alias",operator:"contains",value:t},{field:"group",operator:"contains",value:t}]}),t.length>2&&$("#btnSearchDeviceContacts").removeClass("hidden"),$("#btnSearchDeviceName").text(t)):(contactModel.contactListDS.filter([]),contactsView.hideSearchUX())}),$("#contacts-listview").kendoMobileListView({dataSource:contactModel.contactListDS,template:$("#contactsTemplate").html(),headerTemplate:$("#contactsHeaderTemplate").html(),fixedHeaders:!0,click:function(t){var e=t.dataItem;return e=contactModel.findContactByUUID(e.uuid),void 0===e?void mobileNotify("Contact List: no matching Contact in ContactsDS"):(updateCurrentContact(e),void("phone"===e.category?contactModel.unifiedDeviceContact?launchAddContact({dataItem:e}):APP.kendo.navigate("#contactImport?query="+e.name):(contactActionView.openModal(e.uuid),void 0!==e.contactUUID&&null!==e.contactUUID?$("#contactActionBtns > li:first-child").show():$("#contactActionBtns > li:first-child").hide())))},dataBound:function(t){ux.checkEmptyUIState(contactModel.contactListDS,"#contactListDiv >")}}).kendoTouch({filter:".contactListBox",enableSwipe:!0,swipe:function(t){var e=t.sender.events.currentTarget;if("left"===t.direction){var a=$(".contact-active");$(a).velocity({translateX:"0"},{duration:"fast"}).removeClass("contact-active"),$(e).hasClass("member")&&$(window).width()<375?$(e).velocity({translateX:"-50%"},{duration:"fast"}).addClass("contact-active"):$(e).hasClass("member")?$(e).velocity({translateX:"-40%"},{duration:"fast"}).addClass("contact-active"):$(window).width()<375?$(e).velocity({translateX:"-85%"},{duration:"fast"}).addClass("contact-active"):$(e).velocity({translateX:"-75%"},{duration:"fast"}).addClass("contact-active")}"right"===t.direction&&$(e).hasClass("contact-active")&&$(e).velocity({translateX:"0"},{duration:"fast"}).removeClass("contact-active")}})},onShow:function(t){_preventDefault(t),contactModel.updateContactListStatus(),ux.scrollUpSearch(t),ux.showActionBtn(!0,"#contacts","#contactImport"),ux.showActionBtnText("#contacts","3em","New Contact")},updateContactListDS:function(){contactModel.contactListDS.data([]),contactModel.contactListDS.data(contactModel.contactsDS.data())},onBeforeHide:function(){ux.showActionBtn(!1,"#contacts")},updateSearchUX:function(t){var e=$("#contactSearchQuery").val();e.length>2?($("#btnSearchDeviceName").text(e),$("#btnSearchDeviceContacts").removeClass("hidden")):contactsView.hideSearchUX()},hideSearchUX:function(){contactModel.deviceContactsDS.data([]),$("#btnSearchDeviceContacts").addClass("hidden")},searchDeviceContacts:function(t){void 0!==t&&void 0!==t.preventDefault&&t.preventDefault();var e=$("#contactsSearchQuery").val();APP.kendo.navigate("#contactImport?query="+e)},doEditContact:function(t){_preventDefault(t);var e=t.button[0].attributes["data-contact"].value;APP.kendo.navigate("#editContact?contact="+e)},doDeleteContact:function(t){_preventDefault(t);var e=t.button[0].attributes["data-contact"].value;contactModel.deleteContact(e);var a="Deleted contact: "+contactModel.currentContact.name+" ("+contactModel.currentContact.alias+")";mobileNotify(a),APP.kendo.navigate("#contacts")},doInviteContact:function(t){_preventDefault(t);var e=t.button[0].attributes["data-contact"].value,a=contactModel.findContactByUUID(e),o=a.email,c=a.inviteSent;void 0===c||c===!1?(contactSendEmailInvite(o),contactModel.currentContact.set("inviteSent",!0),contactModel.currentContact.set("lastInvite",ggTime.currentTime())):mobileNotify(a.name+"has already been invited")}},contactImportView={onInit:function(t){void 0!==t&&void 0!==t.preventDefault&&t.preventDefault(),$("#contactimport-listview").kendoMobileListView({dataSource:contactModel.deviceContactsDS,template:$("#deviceContactsTemplate").html(),headerTemplate:"${value}",fixedHeaders:!0,click:contactImportView.processDeviceContact}),$("#addContactPhone").change(function(){var t=$("#addContactPhone").val();mobileNotify("Please wait - validating phone..."),isValidMobileNumber(t,function(e){"ok"===e.status&&e.valid===!1&&mobileNotify(t+"is not a valid mobile number")})}),$("#contactImportQuery").change(function(t){var e=$("#contactImportQuery").val();e.length>2?$(".enterSearch > span").css("color","#2E93FD"):$(".enterSearch > span").css("color","#E0E0E0")}).keyup(function(t){13===t.keyCode&&contactImportView.searchContacts()})},onShow:function(t){void 0!==t&&void 0!==t.preventDefault&&t.preventDefault();var e=t.view.params.query;void 0!==e&&($("#contactImportQuery").val(e),deviceFindContacts(e))},searchContacts:function(t){void 0!==t&&void 0!==t.preventDefault&&t.preventDefault();var e=$("#contactImportQuery").val();e.length>2&&deviceFindContacts(e,function(t){})},resetContactImport:function(t){$("#contactImportQuery").val("")},processDeviceContact:function(t){void 0!==t&&void 0!==t.preventDefault&&t.preventDefault(),contactModel.currentDeviceContact=t.dataItem,mobileNotify("Unifying contact information for "+t.dataItem.name),syncContactWithDevice(t.dataItem.name,function(t){contactModel.emailArray=[];for(var e=0;e<contactModel.currentDeviceContact.emails.length;e++){var a={};a.name=contactModel.currentDeviceContact.emails[e].name,a.address=contactModel.currentDeviceContact.emails[e].address,contactModel.emailArray.push(a)}contactModel.phoneArray=[];for(var o=0;o<contactModel.currentDeviceContact.phoneNumbers.length;o++){var c={};c.name=contactModel.currentDeviceContact.phoneNumbers[o].name,c.number=contactModel.currentDeviceContact.phoneNumbers[o].number,contactModel.phoneArray.push(c)}contactModel.addressArray=[];for(var n=0;n<contactModel.currentDeviceContact.addresses.length;n++){var i={};i.name=contactModel.currentDeviceContact.addresses[n].name,i.address=contactModel.currentDeviceContact.addresses[n].fullAddress,contactModel.addressArray.push(i)}contactModel.phoneDS.data(contactModel.phoneArray),contactModel.emailDS.data(contactModel.emailArray),contactModel.addressDS.data(contactModel.addressArray);var d=contactModel.currentDeviceContact,r=d.name;$("#addContactName").val(r),null!==d.photo&&returnValidPhoto(d.photo,function(t){$("#addContactPhoto").attr("src",t)}),contactModel.deviceContactsDS.data([t[0]]),contactImportView.launchAddContact()})},launchAddContact:function(){$("#modalview-AddContact").data("kendoMobileModalView").open()}},addContactView={doInit:function(t){void 0!==t&&void 0!==t.preventDefault&&t.preventDefault(),$("#addContactPhone").change(function(){var t=$("#addContactPhone").val();isValidMobileNumber(t,function(e){"ok"===e.status&&e.valid===!1&&mobileNotify(t+"is not a valid mobile number")})})},doShow:function(t){void 0!==t&&void 0!==t.preventDefault&&t.preventDefault();var e=contactModel.currentDeviceContact,a=e.name;$("#addContactName").val(a),null===e.photo?$("#addContactPhoto").attr("src","images/ghostgramcontact.png"):returnValidPhoto(e.photo,function(t){$("#addContactPhoto").attr("src",t)}),contactModel.emailArray=new Array;for(var o=0;o<contactModel.currentDeviceContact.emails.length;o++){var c=new Object;c.name=contactModel.currentDeviceContact.emails[o].name,c.address=contactModel.currentDeviceContact.emails[o].address,contactModel.emailArray.push(c)}contactModel.phoneArray=new Array;for(var n=0;n<contactModel.currentDeviceContact.phoneNumbers.length;n++){var i=new Object;i.name=contactModel.currentDeviceContact.phoneNumbers[n].name,i.number=contactModel.currentDeviceContact.phoneNumbers[n].number,contactModel.phoneArray.push(i)}contactModel.addressArray=new Array;for(var d=0;d<contactModel.currentDeviceContact.addresses.length;d++){var r=new Object;r.name=contactModel.currentDeviceContact.addresses[d].name,r.address=contactModel.currentDeviceContact.addresses[d].fullAddress,contactModel.addressArray.push(r)}contactModel.phoneDS.data(contactModel.phoneArray),contactModel.emailDS.data(contactModel.emailArray),contactModel.addressDS.data(contactModel.addressArray);var e=contactModel.currentDeviceContact,a=e.name;$("#addContactName").val(a),null!==e.photo&&returnValidPhoto(e.photo,function(t){$("#addContactPhoto").attr("src",t)})},addChatContact:function(t,e,a,o){var c=Parse.Object.extend("contacts"),n=new c;n.setACL(userModel.parseACL),n.set("name",e),n.set("alias",a),n.set("category","unknown"),n.set("address",null),n.set("group",null),n.set("priority",0),n.set("isFavorite",!1),n.set("uuid",t),n.set("contactUUID",o),n.set("contactPhone",null),n.set("contactEmail",null),n.set("ownerUUID",userModel.currentUser.userUUID),n.save(null,{success:function(e){var a=contactModel.createIdenticon(t);e.set("photo",a),contactModel.contactsDS.add(e.attributes),contactModel.contactListDS.add(e.attributes)},error:function(t,e){handleParseError(e)}})},addContact:function(t){_preventDefault(t);var e=Parse.Object.extend("contacts"),a=new e,o=$("#addContactName").val(),c=$("#addContactAlias").val(),n=$("#addContactPhone").val(),i=$("#addContactEmail").val(),d=$("#addContactPhoto").prop("src"),r=$("#addContactGroup").val(),s=$("#addContactAddress").val(),l=uuid.v4();return a.setACL(userModel.parseACL),a.set("name",o),a.set("alias",c),a.set("address",s),a.set("group",r),a.set("category","new"),a.set("priority",0),a.set("isFavorite",!1),a.set("uuid",l),a.set("contactUUID",null),a.set("contactPhone",null),a.set("contactEmail",null),a.set("ownerUUID",userModel.currentUser.userUUID),n=n.replace(/\D+/g,""),"1"!==n[0]&&(n="1"+n),void 0!==contactModel.findContactByPhone(n)?(mobileNotify("Existing contact with this phone number"),void $("#modalview-AddContact").data("kendoMobileModalView").close()):(a.set("phone",n),$("#modalview-AddContact").data("kendoMobileModalView").close(),mobileNotify("Invite sent"),void findUserByPhone(n,function(t){if(t.found){var e=t.user;a.set("phoneVerified",e.phoneVerified),e.emailVerified?(a.set("email",e.email),a.set("emailValidated",!0)):(a.set("email",i),a.set("emailValidated",!1)),a.set("contactUUID",e.userUUID),a.set("contactPhone",e.phone),a.set("phoneVerified",e.phoneVerified),e.phoneVerified&&a.set("category","member"),a.set("contactEmail",e.email),a.set("photo",null),a.set("contactPhoto",e.photo),a.set("publicKey",e.publicKey)}else a.set("email",i),contactSendEmailInvite(i),a.set("phoneVerified",!1),a.set("publicKey",null),a.set("contactUUID",null),a.set("contactPhone",null),a.set("contactEmail",null);a.save(null,{success:function(t){mobileNotify("Added contact : "+t.get("name"));var e=contactModel.createIdenticon(l);t.set("identicon",e),(null!==t.attributes.photo||""!==t.attributes.photo)&&t.set("photo",e),contactModel.contactsDS.add(t.attributes),APP.kendo.navigate("#contacts")},error:function(t,e){handleParseError(e)}})}))}},editContactView={_activeContact:new kendo.data.ObservableObject,onInit:function(t){_preventDefault(t)},updateVerifiedUX:function(t,e){t&&($("#edit-verified-phone").removeClass("hidden"),$("#editContactPhone").prop("readonly",!0)),e&&($("#edit-verified-email").removeClass("hidden"),$("#editContactEmail").prop("readonly",!0))},setActiveContact:function(t){void 0!==t&&(editContactView._activeContact.set("uuid",t.uuid),editContactView._activeContact.set("name",t.name),editContactView._activeContact.set("alias",t.alias),editContactView._activeContact.set("phone",t.phone),editContactView._activeContact.set("email",t.email),editContactView._activeContact.set("group",t.group),editContactView._activeContact.set("photo",t.photo),editContactView._activeContact.set("address",t.address))},updateContact:function(){var t=contactModel.findContactByUUID(editContactView._activeContact.uuid);t.set("name",editContactView._activeContact.name),t.set("alias",editContactView._activeContact.alias),t.set("phone",editContactView._activeContact.phone),t.set("email",editContactView._activeContact.email),t.set("photo",editContactView._activeContact.photo),t.set("group",editContactView._activeContact.group),t.set("address",editContactView._activeContact.address),updateParseObject("contacts","uuid",editContactView._activeContact.uuid,"name",editContactView._activeContact.name),updateParseObject("contacts","uuid",editContactView._activeContact.uuid,"alias",editContactView._activeContact.alias),updateParseObject("contacts","uuid",editContactView._activeContact.uuid,"phone",editContactView._activeContact.phone),updateParseObject("contacts","uuid",editContactView._activeContact.uuid,"email",editContactView._activeContact.email),updateParseObject("contacts","uuid",editContactView._activeContact.uuid,"photo",editContactView._activeContact.photo),updateParseObject("contacts","uuid",editContactView._activeContact.uuid,"group",editContactView._activeContact.group),updateParseObject("contacts","uuid",editContactView._activeContact.uuid,"address",editContactView._activeContact.address),editContactView.onDone()},syncActiveContact:function(t){_preventDefault(t),"emailVerified"!==t.field&&updateParseObject("contacts","uuid",editContactView._activeContact.uuid,t.field,this[t.field])},onShow:function(t){_preventDefault(t);var e=t.view.params.contact,a=null;a=contactModel.findContactByUUID(e),void 0!==a?editContactView.setActiveContact(a):mobileNotify("EditContact : invalid contactId "+e),contactModel.updateContactDetails(e,function(t){editContactView.setActiveContact(t),editContactView.updateVerifiedUX(t.phoneVerified,t.emailValidated)})},onDone:function(t){_preventDefault(t),APP.kendo.navigate("#contacts"),$("#contactEditList").velocity("fadeIn")},syncWithParse:function(t){_preventDefault(t),mobileNotify("Getting lastest info for "+contactModel.currentContact.name);var e=contactModel.currentContact;void 0!==e.contactUUID?getUserContactInfo(e.contactUUID,function(t){if(t.found){var a=t.user,o=!1;e.email!==a.email&&(o=!0,e.email=a.email,mobileNotify(e.name+" has changed their preferred email.")),e.phone!==a.phone&&(o=!0,e.phone=a.phone,mobileNotify(e.name+" has changed their preferred phone.")),e.phoneVerified!==a.phoneVerified&&(o=!0,e.phoneVerified=a.phoneVerified,mobileNotify(e.name+" has verified their phone.")),e.emailValidated!==a.emailVerified&&(o=!0,e.set("emailValidated",a.emailVerified),mobileNotify(e.name+" has verified their email.")),e.publicKey!==a.publicKey&&(o=!0,e.publicKey=a.publicKey),editContactView.updateVerifiedUX(e.phoneVerified,e.emailValidated)}}):findUserByPhone(e.phone,function(t){if(t.found){var a=t.user,o=!1;e.email!==a.email&&(o=!0,e.email=a.email,mobileNotify(e.name+" has changed their preferred email.")),e.phone!==a.phone&&(o=!0,e.phone=a.phone,mobileNotify(e.name+" has changed their preferred phone.")),e.phoneVerified!==a.phoneVerified&&(o=!0,e.phoneVerified=a.phoneVerified,mobileNotify(e.name+" has verified their phone.")),e.emailValidated!==a.emailVerified&&(o=!0,e.set("emailValidated",a.emailVerified),mobileNotify(e.name+" has verified their email.")),e.publicKey!==a.publicKey&&(o=!0,e.publicKey=a.publicKey),editContactView.updateVerifiedUX(e.phoneVerified,e.emailValidated)}})},syncWithDevice:function(t){}},contactActionView={_activeContactId:null,_activeContact:new kendo.data.ObservableObject,onInit:function(t){},refreshUX:function(t){"unknown"===t.category?($("#contactActionBtns").addClass("hidden"),$("#contactActionConnect").removeClass("hidden"),$("#contactActionAccept").addClass("hidden")):($("#contactActionBtns").removeClass("hidden"),$("#contactActionConnect").addClass("hidden"),$("#contactActionAccept").addClass("hidden"),"member"===t.category?$("#contactActionBtns > li:first-child").show():$("#contactActionBtns > li:first-child").hide())},openModal:function(t){$("#contactActionBtns").removeClass("hidden");var e=contactModel.findContactByUUID(t);contactActionView.setContact(e),contactActionView.refreshUX(e),$(".statusContactCard-icon").attr("src","images/status-away.svg"),void 0!==e.contactUUID&&null!==e.contactUUID&&contactModel.getContactStatusObject(e.contactUUID,function(t){if(null!==t){var a=t.get("isAvailable");contactActionView._activeContact.set("statusMessage",t.get("statusMessage")),contactActionView._activeContact.set("currentPlace",t.get("currentPlace")),contactActionView._activeContact.set("currentPlaceUUID",t.get("currentPlaceUUID")),contactActionView._activeContact.set("isAvailable",a),a&&$(".statusContactCard-icon").attr("src","images/status-available.svg");var o=contactModel.findContactList(e.contactUUID);o.set("statusMessage",t.get("statusMessage"));var c=t.get("currentPlace");o.set("currentPlace",c),o.set("currentPlaceUUID",t.get("currentPlaceUUID")),o.set("isAvailable",a),""!==c&&void 0!==c&&$("#contactCurrentPlace").text("@"+c)}}),contactModel.updateContactDetails(t,function(e){void 0===e&&(e=contactModel.findContactByUUID(t));var a=e.name,o=e.alias,c=e.phoneVerified,n=e.isAvailable;contactActionView._activeContact.set("name",a),contactActionView._activeContact.set("alias",o),void 0!==e.photo&&null!==e.photo?contactActionView._activeContact.set("photo",e.photo):contactActionView._activeContact.set("photo",e.identicon),ux.formatNameAlias(a,o,"#modalview-contactActions"),c?$("#currentContactVerified").removeClass("hidden"):$("#currentContactVerified").addClass("hidden"),$("#contactProfileImg").attr("src",e.photo),contactActionView.refreshUX(e)}),$("#modalview-contactActions").data("kendoMobileModalView").open(),$("#contactProfileImg").velocity("fadeIn",{delay:150,duration:300,display:"inline-block"}),$("#contactStatusImg").velocity("fadeIn",{delay:150,duration:300,display:"inline-block"}),$("#modalview-contactActions .modal-top h3").velocity({translateY:"20%",opacity:1},{delay:300,duration:500,display:"block"}),$("#modalview-contactActions .modal-top p").velocity({translateY:"20%",opacity:1},{delay:600,duration:500,display:"block"}),$("#modalview-contactActions .modal-bottom .hasMotion").velocity("fadeIn",{duration:500,delay:700})},closeModal:function(){$("#modalview-contactActions").data("kendoMobileModalView").close(),$("#contactCurrentPlace").text(""),$("#modalview-contactActions .preMotionUp, #modalview-contactActions .hasMotion").css("display","none").velocity("fadeOut",{opacity:0,translateY:"0%"}),$("#contactProfileImg, #contactStatusImg").css("opacity",0)},restoreModal:function(){contactActionView.openModal(contactActionView._activeContactId)},ghostEmail:function(t){_preventDefault(t);var e=APP.kendo.view().id;contactActionView.closeModal(),APP.kendo.navigate("#ghostEditor?returnview="+e+"&callback=contactaction")},setContact:function(t){contactActionView._activeContactId=t.uuid,contactActionView._activeContact.set("name",t.name),contactActionView._activeContact.set("alias",t.alias),contactActionView._activeContact.set("photo",t.photo),contactActionView._activeContact.set("statusMessage",t.statusMessage),contactActionView._activeContact.set("currentPlace",t.currentPlace),contactActionView._activeContact.set("isAvailable",t.isAvailable),t.isAvailable&&$(".statusContactCard-icon").attr("src","images/status-available.svg"),t.phoneVerified?$("#currentContactVerified").removeClass("hidden"):$("#currentContactVerified").addClass("hidden")}};